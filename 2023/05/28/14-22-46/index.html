<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"rosevvi.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="SpringCloud">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud">
<meta property="og:url" content="http://rosevvi.cn/2023/05/28/14-22-46/index.html">
<meta property="og:site_name" content="Rosevvi">
<meta property="og:description" content="SpringCloud">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-05-28T06:22:46.000Z">
<meta property="article:modified_time" content="2023-05-28T06:18:37.869Z">
<meta property="article:author" content="rosevvi">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Spring Cloud">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://rosevvi.cn/2023/05/28/14-22-46/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://rosevvi.cn/2023/05/28/14-22-46/","path":"2023/05/28/14-22-46/","title":"Spring Cloud"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Spring Cloud | Rosevvi</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>
  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Rosevvi</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">少年，你真的要止步于此吗？</p>
      <img class="custom-logo-image" src="/uploads/logo.jpg" alt="Rosevvi">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringCloud"><span class="nav-number">1.</span> <span class="nav-text">SpringCloud</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.</span> <span class="nav-text">微服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9F"><span class="nav-number">1.1.1.</span> <span class="nav-text">什么是微服务？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-number">1.1.2.</span> <span class="nav-text">微服务技术栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.3.</span> <span class="nav-text">认识微服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">微服务远程调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">1.2.1.</span> <span class="nav-text">微服务调用方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">1.2.2.</span> <span class="nav-text">提供者与消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EureKa%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.3.</span> <span class="nav-text">EureKa注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.1.</span> <span class="nav-text">服务调用出现的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EureKa%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">1.3.2.</span> <span class="nav-text">EureKa的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BAEurekaServer"><span class="nav-number">1.3.3.</span> <span class="nav-text">搭建EurekaServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="nav-number">1.3.4.</span> <span class="nav-text">服务注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="nav-number">1.3.5.</span> <span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.3.6.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.3.6.1.</span> <span class="nav-text">Ribbon负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8E%9F%E7%90%86"><span class="nav-number">1.3.6.1.1.</span> <span class="nav-text">负载均衡原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.6.1.2.</span> <span class="nav-text">负载均衡策略</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="nav-number">1.3.6.1.3.</span> <span class="nav-text">饥饿加载</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">1.4.</span> <span class="nav-text">Nacos注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%86%E5%92%8C%E5%AE%89%E8%A3%85Nacos"><span class="nav-number">1.4.1.</span> <span class="nav-text">认识和安装Nacos</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">安装步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%88%B0Nacos"><span class="nav-number">1.4.2.</span> <span class="nav-text">服务注册到Nacos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nacos%E6%9C%8D%E5%8A%A1%E5%88%86%E7%BA%A7%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.4.3.</span> <span class="nav-text">nacos服务分级存储模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">根据集群负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E6%9D%83%E9%87%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">根据权重负载均衡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB-namespace"><span class="nav-number">1.4.4.</span> <span class="nav-text">环境隔离-namespace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos%E4%B8%8Eeureka%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.4.5.</span> <span class="nav-text">Nacos与eureka的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">1.5.</span> <span class="nav-text">Nacos配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9F%E4%B8%80%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">1.5.1.</span> <span class="nav-text">统一配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%8B%89%E5%8F%96"><span class="nav-number">1.5.2.</span> <span class="nav-text">微服务配置拉取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="nav-number">1.5.3.</span> <span class="nav-text">多环境配置共享</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">1.5.4.</span> <span class="nav-text">Nacos集群搭建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http%E5%AE%A2%E6%88%B7%E7%AB%AFFeign"><span class="nav-number">1.6.</span> <span class="nav-text">http客户端Feign</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RestTemplate%E6%96%B9%E5%BC%8F%E8%B0%83%E7%94%A8%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.6.1.</span> <span class="nav-text">RestTemplate方式调用存在的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.6.2.</span> <span class="nav-text">Feign的介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Feign%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">1.6.3.</span> <span class="nav-text">自定义Feign的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.6.4.</span> <span class="nav-text">Feign的性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Feign%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.6.5.</span> <span class="nav-text">Feign的最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%88%E7%BB%A7%E6%89%BF%EF%BC%89%EF%BC%9A"><span class="nav-number">1.6.5.1.</span> <span class="nav-text">方式一（继承）：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%88%E6%8A%BD%E5%8F%96%EF%BC%89%EF%BC%9A"><span class="nav-number">1.6.5.2.</span> <span class="nav-text">方式二（抽取）：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%9C%80%E4%BD%B3%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E4%BA%8C"><span class="nav-number">1.6.5.3.</span> <span class="nav-text">实现最佳实现方式二</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GateWay%E7%BD%91%E5%85%B3"><span class="nav-number">1.7.</span> <span class="nav-text">GateWay网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="nav-number">1.7.1.</span> <span class="nav-text">网关的功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E7%9A%84%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.7.2.</span> <span class="nav-text">网关的技术实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.7.3.</span> <span class="nav-text">搭建网关服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82RoutePredicateFactory"><span class="nav-number">1.7.4.</span> <span class="nav-text">路由断言工厂RoutePredicateFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8GatewayFilter"><span class="nav-number">1.7.5.</span> <span class="nav-text">路由过滤器GatewayFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8GlobleFilter"><span class="nav-number">1.7.6.</span> <span class="nav-text">全局过滤器GlobleFilter</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="nav-number">1.7.6.1.</span> <span class="nav-text">过滤器的执行顺序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="nav-number">1.7.7.</span> <span class="nav-text">网关跨域问题处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker"><span class="nav-number">1.8.</span> <span class="nav-text">Docker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%B7%AE%E5%BC%82%EF%BC%9A"><span class="nav-number">1.8.1.</span> <span class="nav-text">Docker和虚拟机的差异：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker%E6%9E%B6%E6%9E%84"><span class="nav-number">1.8.2.</span> <span class="nav-text">Docker架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Docker"><span class="nav-number">1.8.3.</span> <span class="nav-text">安装Docker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="nav-number">1.8.3.1.</span> <span class="nav-text">常用命令：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-CentOs%E5%AE%89%E8%A3%85Docker"><span class="nav-number">1.8.3.2.</span> <span class="nav-text">1.CentOs安装Docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1%E5%8D%B8%E8%BD%BD%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">1.8.3.3.</span> <span class="nav-text">1.1卸载（可选）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E5%AE%89%E8%A3%85Docker"><span class="nav-number">1.8.3.4.</span> <span class="nav-text">1.2 安装Docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-%E5%90%AF%E5%8A%A8docker"><span class="nav-number">1.8.3.5.</span> <span class="nav-text">1.3 启动docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F"><span class="nav-number">1.8.3.6.</span> <span class="nav-text">1.4 配置镜像</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%BB%83%E4%B9%A0"><span class="nav-number">1.8.4.</span> <span class="nav-text">容器练习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="nav-number">1.8.5.</span> <span class="nav-text">数据卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E6%8C%82%E8%BD%BD"><span class="nav-number">1.8.6.</span> <span class="nav-text">数据卷挂载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95%E6%8C%82%E8%BD%BD"><span class="nav-number">1.8.6.1.</span> <span class="nav-text">宿主机目录挂载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DockerFile%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F"><span class="nav-number">1.8.7.</span> <span class="nav-text">DockerFile自定义镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="nav-number">1.8.7.1.</span> <span class="nav-text">镜像结构：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DockerFile"><span class="nav-number">1.8.7.2.</span> <span class="nav-text">DockerFile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DockerCompose"><span class="nav-number">1.8.7.3.</span> <span class="nav-text">DockerCompose</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MQ"><span class="nav-number">1.9.</span> <span class="nav-text">MQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ"><span class="nav-number">1.9.1.</span> <span class="nav-text">RabbitMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">单机部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">消息模型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringAMQP"><span class="nav-number">1.9.2.</span> <span class="nav-text">SpringAMQP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WorkQueue%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="nav-number">1.9.3.</span> <span class="nav-text">WorkQueue工作队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85-FanoutExchange"><span class="nav-number">1.9.4.</span> <span class="nav-text">发布订阅-FanoutExchange</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85-DirectExchange"><span class="nav-number">1.9.5.</span> <span class="nav-text">发布订阅-DirectExchange</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85-TopicExchange"><span class="nav-number">1.9.6.</span> <span class="nav-text">发布订阅-TopicExchange</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="nav-number">1.9.7.</span> <span class="nav-text">消息转换器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2ElasticSearch"><span class="nav-number">1.10.</span> <span class="nav-text">分布式搜索ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%90%91%E7%B4%A2%E5%BC%95%E5%92%8C%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">1.10.1.</span> <span class="nav-text">正向索引和倒排索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85ElasticSearch"><span class="nav-number">1.10.2.</span> <span class="nav-text">安装ElasticSearch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2kibana"><span class="nav-number">1.10.3.</span> <span class="nav-text">部署kibana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85IK%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">1.10.4.</span> <span class="nav-text">安装IK分词器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.10.4.1.</span> <span class="nav-text">安装</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IK%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">1.10.5.</span> <span class="nav-text">IK分词器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E8%AF%8D%E5%BA%93-%E5%81%9C%E7%94%A8%E8%AF%8D%E5%BA%93"><span class="nav-number">1.10.5.1.</span> <span class="nav-text">扩展词库-停用词库</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">1.10.6.</span> <span class="nav-text">索引库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mapping%E5%B1%9E%E6%80%A7"><span class="nav-number">1.10.6.1.</span> <span class="nav-text">mapping属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">1.10.6.2.</span> <span class="nav-text">创建索引库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">1.10.6.3.</span> <span class="nav-text">索引库操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="nav-number">1.10.6.4.</span> <span class="nav-text">文档操作</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RestClient%E6%93%8D%E4%BD%9C%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">1.10.7.</span> <span class="nav-text">RestClient操作索引库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="nav-number">1.10.7.1.</span> <span class="nav-text">步骤二：数据分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96RestClient"><span class="nav-number">1.10.7.2.</span> <span class="nav-text">步骤三：初始化RestClient</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">1.10.7.3.</span> <span class="nav-text">步骤四：创建索引库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%94%EF%BC%9A%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93%E3%80%81%E5%88%A4%E6%96%AD%E7%B4%A2%E5%BC%95%E5%BA%93%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">1.10.7.4.</span> <span class="nav-text">步骤五：删除索引库、判断索引库是否存在</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RestClient%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3"><span class="nav-number">1.10.8.</span> <span class="nav-text">RestClient操作文档</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.10.8.1.</span> <span class="nav-text">步骤一：初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A%E6%B7%BB%E5%8A%A0%E9%85%92%E5%BA%97%E6%95%B0%E6%8D%AE%E5%88%B0%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">1.10.8.2.</span> <span class="nav-text">步骤2：添加酒店数据到索引库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%89%EF%BC%9A%E6%A0%B9%E6%8D%AEid%E6%9F%A5%E8%AF%A2%E9%85%92%E5%BA%97%E6%95%B0%E6%8D%AE"><span class="nav-number">1.10.8.3.</span> <span class="nav-text">步骤三：根据id查询酒店数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B%EF%BC%9A%E6%A0%B9%E6%8D%AEid%E4%BF%AE%E6%94%B9%E9%85%92%E5%BA%97%E6%95%B0%E6%8D%AE"><span class="nav-number">1.10.8.4.</span> <span class="nav-text">步骤四：根据id修改酒店数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%94%EF%BC%9A%E6%A0%B9%E6%8D%AEid%E5%88%A0%E9%99%A4%E9%85%92%E5%BA%97%E6%95%B0%E6%8D%AE"><span class="nav-number">1.10.8.5.</span> <span class="nav-text">步骤五：根据id删除酒店数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tip%EF%BC%9A%E6%89%B9%E5%A4%84%E7%90%86"><span class="nav-number">1.10.8.6.</span> <span class="nav-text">tip：批处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DSL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95"><span class="nav-number">1.10.9.</span> <span class="nav-text">DSL查询语法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DSLQuery%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">1.10.9.1.</span> <span class="nav-text">DSLQuery的分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DSL-Query%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-number">1.10.9.2.</span> <span class="nav-text">DSL Query基本语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.10.9.3.</span> <span class="nav-text">全文检索查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.10.9.4.</span> <span class="nav-text">精确查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%B0%E7%90%86%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.10.9.5.</span> <span class="nav-text">地理查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.10.9.6.</span> <span class="nav-text">复合查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FunctionScoreQuery"><span class="nav-number">1.10.9.7.</span> <span class="nav-text">FunctionScoreQuery</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BooleanQuery"><span class="nav-number">1.10.9.8.</span> <span class="nav-text">BooleanQuery</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="nav-number">1.10.10.</span> <span class="nav-text">搜索结果处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">1.10.10.1.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5"><span class="nav-number">1.10.10.2.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E4%BA%AE"><span class="nav-number">1.10.10.3.</span> <span class="nav-text">高亮</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RestClient%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="nav-number">1.10.11.</span> <span class="nav-text">RestClient查询文档</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">1.10.11.1.</span> <span class="nav-text">快速入门</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2-1"><span class="nav-number">1.10.11.2.</span> <span class="nav-text">全文检索查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E9%A1%B5"><span class="nav-number">1.10.11.3.</span> <span class="nav-text">排序和分页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AB%98%E4%BA%AE-1"><span class="nav-number">1.10.11.4.</span> <span class="nav-text">高亮</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="nav-number">1.10.12.</span> <span class="nav-text">数据聚合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DSL%E5%AE%9E%E7%8E%B0Bucket%E8%81%9A%E5%90%88"><span class="nav-number">1.10.12.1.</span> <span class="nav-text">DSL实现Bucket聚合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DSL%E5%AE%9E%E7%8E%B0Metrics%E8%81%9A%E5%90%88"><span class="nav-number">1.10.12.2.</span> <span class="nav-text">DSL实现Metrics聚合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RestClient%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="nav-number">1.10.12.3.</span> <span class="nav-text">RestClient实现聚合</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="nav-number">1.10.13.</span> <span class="nav-text">自动补全</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">1.10.13.1.</span> <span class="nav-text">拼音分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">1.10.13.2.</span> <span class="nav-text">自定义分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#completion-suggester%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.10.13.3.</span> <span class="nav-text">completion suggester查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RestApi%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="nav-number">1.10.13.4.</span> <span class="nav-text">RestApi实现自动补全</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5-%E9%87%8D%E8%A6%81"><span class="nav-number">1.10.14.</span> <span class="nav-text">数据同步(重要)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="nav-number">1.10.14.1.</span> <span class="nav-text">同步调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="nav-number">1.10.14.2.</span> <span class="nav-text">异步调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E5%90%ACbinlog"><span class="nav-number">1.10.14.3.</span> <span class="nav-text">监听binlog</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-number">1.10.14.4.</span> <span class="nav-text">案例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C"><span class="nav-number">1.10.14.4.1.</span> <span class="nav-text">步骤二</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%89"><span class="nav-number">1.10.14.4.2.</span> <span class="nav-text">步骤三</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E5%9B%9B"><span class="nav-number">1.10.14.4.3.</span> <span class="nav-text">步骤四</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES%E9%9B%86%E7%BE%A4"><span class="nav-number">1.10.15.</span> <span class="nav-text">ES集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">1.10.15.1.</span> <span class="nav-text">搭建集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="nav-number">1.10.15.2.</span> <span class="nav-text">集群状态监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ES%E9%9B%86%E7%BE%A4%E8%81%8C%E8%B4%A3%E5%92%8C%E8%84%91%E8%A3%82"><span class="nav-number">1.10.15.3.</span> <span class="nav-text">ES集群职责和脑裂</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%84%91%E8%A3%82"><span class="nav-number">1.10.15.3.1.</span> <span class="nav-text">脑裂</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ES%E9%9B%86%E7%BE%A4%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="nav-number">1.10.15.4.</span> <span class="nav-text">ES集群的分布式存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="nav-number">1.10.15.5.</span> <span class="nav-text">故障转移</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel"><span class="nav-number">1.11.</span> <span class="nav-text">Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="nav-number">1.11.1.</span> <span class="nav-text">雪崩问题</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rosevvi"
      src="/uploads/gzh.jpg">
  <p class="site-author-name" itemprop="name">rosevvi</p>
  <div class="site-description" itemprop="description">一个充满激情的少年</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/rosevvi" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rosevvi" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://rosevvi.cn/2023/05/28/14-22-46/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/gzh.jpg">
      <meta itemprop="name" content="rosevvi">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rosevvi">
      <meta itemprop="description" content="一个充满激情的少年">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Spring Cloud | Rosevvi">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Cloud
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-05-28 14:22:46 / 修改时间：14:18:37" itemprop="dateCreated datePublished" datetime="2023-05-28T14:22:46+08:00">2023-05-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>60k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:49</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h1><span id="more"></span>

<h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><h3 id="什么是微服务？"><a href="#什么是微服务？" class="headerlink" title="什么是微服务？"></a>什么是微服务？</h3><p>微服务不等于springcloud，微服务是一种经过良好架构设计的分布架构方案，微服务架构特征：</p>
<ol>
<li>单一职责：微服务拆分粒度更小。每一个服务都对应唯一的业务能力，做到职责单一，避免业务重复开发</li>
<li>面向服务：微服务对外暴露业务接口</li>
<li>自治：团队独立，技术独立，数据独立，部署独立</li>
<li>隔离性强：服务调用做好隔离，容错，降级，避免出现级联问题</li>
</ol>
<h3 id="微服务技术栈"><a href="#微服务技术栈" class="headerlink" title="微服务技术栈"></a>微服务技术栈</h3><p>微服务做的第一件事就是拆分，因为传统单体架构，所有的业务功能全部写在一起，随着业务越来越复杂，代码也耦合的越来越多，将来升级维护就会变得很困难，所以大型的互联网服务都会进行拆分。微服务再做拆分的时候，会根据业务功能模块把一个单体的项目拆分成许多的独立的项目，每个项目完成一部分业务功能，将来独立开发或部署，我们把这一个独立的项目称为服务，一个大型的互联网项目往往会包含数百上千的服务最终形成一个服务集群，而一个业务往往就需要多个服务共同完成。比如说一个请求来了，他可能先去调用服务A，而服务A可能又调用了服务B，而后又去调用了服务C。当业务越来越多也来越复杂的时候，这些服务的调用关系就会越来越复杂，这么复杂的调用关系要让人去记录和维护是不可能的。所以再微服务里会又一个组件叫<strong>注册中心</strong>，它可以去记录微服务里每个服务的ip、端口，以及他们的功能。当有一个服务需要调用另一个服务时它不需要自己去记录对方的ip，只需要去找注册中心就可以，从注册中心去拉取对应的服务信息。同时随着服务越来越多每个服务都有自己的配置文件，将来要更改配置我们要逐一去修改这样就太麻烦了，所以我们还会有一个<strong>配置中心</strong>。它可以去统一的管理整个服务群里成千上百个配置，如果以后又配置需要变更只需要去 找配置中心，他会通知相关的微服务实现配置的热更新当我们的微服务运行起来之后，用户就可以来访问我们了，这时候就还需要一个<strong>网关服务</strong>。那你这里有这么多微服务，用户怎么知道你要访问哪一个呢？而且也不是随便什么人都可以访问我们的服务，这就像是我们的小区，小区里往往有一个看门的大爷，不能什么人来了都可以进入。所以服务网关一部分是对用户身份进行校验，另一方面可以把用户的请求路由到具体的服务，当然再路由过程中也可以去做一些负载均衡。而这时候服务集群根据你的请求去处理业务，该访问数据库就访问数据库并把查询到的数据返回给用户。数据库肯定也是集群，不过集群在庞大也不会有用户数量多，所以数据库将来肯定无法抗住高并发，因此我们还会加入<strong>分布式缓存</strong>， 但是简单查询可以走缓存，一些海量数据的复杂的搜索统计和分析缓存也做不了，这时候就还需要用到<strong>分布式搜索功能</strong>。数据库将来的功能就只需要做一些写操作和一些事务类型的对数据安全较高的一些数据存储。最后再微服务里面还需要一种<strong>异步通讯的消息队列组件</strong>。为什么呢？其实对于分布式的服务或再微服务里面，他的业务往往会跨越多个服务，所以总时长就会等于每个服务执行时长之和，性能就会下降，而异步通讯的意思就是请求来了我调用服务A，而服务A不是去调用服务B和C而是通知他们，B和C去执行之后A就直接结束了，那么通信链路就变短了执行时长也就短了 。所以异步通讯可以大大提高我们的并发，再一些秒杀等高并发场景下就可以去利用了。当然我们如此庞大复杂的一个服务在运行的过程中如果出现什么问题也不好排查。所以在微服务运行中还会引入两个组件来解决这种异常定位。第一个是<strong>分布式日志服务</strong>，它可以去统计整个集群中成千上百个服务他们的运行日志，统一的去做一个存储，统计，分析。将来出现问题就比较好定位了。第二个叫做<strong>系统监控链路追踪</strong>，他可以去实时监控我们整个集群中每个服务节点的运行状态，Cpu的负载、内存的占用等等情况，一旦出现问题直接可以定位到具体的某一个方法和栈信息。那这么大的服务怎么部署呢？未来我们会做一些自动化的部署，<strong>持续集成</strong>：利用<strong>Jenkins</strong>这样的工具，它可以帮助我们对这些微服务项目进行自动化的编译，而基于<strong>Docker</strong>来进行一些打包形成镜像，再基于<strong>kubernetes</strong>或<strong>rancher</strong>这样的技术实现自动化的部署，这一套我们就称为叫持续集成。以上全部才叫做微服务技术栈</p>
<h3 id="认识微服务"><a href="#认识微服务" class="headerlink" title="认识微服务"></a>认识微服务</h3><p>单体架构：将业务的所有功能集中在一个项目中开发，达成一个包部署。</p>
<p>优点：</p>
<ol>
<li>架构简单</li>
<li>部署成本低</li>
</ol>
<p>缺点：</p>
<ol>
<li>耦合度高</li>
</ol>
<p>分布式架构：</p>
<p>分布式架构：根据业务功能对系统进行拆分，每个业务模块作为独立项目开发，称为一个服务。</p>
<ol>
<li>降低服务耦合</li>
<li>有利于服务升级拓展</li>
</ol>
<p>分布式架构要考虑的问题：</p>
<ul>
<li>服务拆分粒度如何？</li>
<li>服务集群地址如何维护？</li>
<li>服务之间如何实现远程调用？</li>
<li>服务健康状态如何感知？</li>
</ul>
<h2 id="微服务远程调用"><a href="#微服务远程调用" class="headerlink" title="微服务远程调用"></a>微服务远程调用</h2><h3 id="微服务调用方式"><a href="#微服务调用方式" class="headerlink" title="微服务调用方式"></a>微服务调用方式</h3><ol>
<li>基于RestTemplate发起的http请求实现远程调用</li>
<li>http请求做远程调用是 与语言无关的调用，只要知道对方的ip、端口、接口路径、请求参数即可</li>
</ol>
<h3 id="提供者与消费者"><a href="#提供者与消费者" class="headerlink" title="提供者与消费者"></a>提供者与消费者</h3><ul>
<li>服务提供者：一次业务中，被其他微服务调用的服务（提供接口给其他微服务）</li>
<li>服务消费者：一次业务中，调用其他微服务的服务（调用其他微服务提供的接口）</li>
</ul>
<p>​			如果服务A调用服务B，服务B调用了服务C，那么服务B是什么角色？</p>
<p>​			一个服务既可以是提供者也可以是消费者</p>
<h2 id="EureKa注册中心"><a href="#EureKa注册中心" class="headerlink" title="EureKa注册中心"></a>EureKa注册中心</h2><h3 id="服务调用出现的问题"><a href="#服务调用出现的问题" class="headerlink" title="服务调用出现的问题"></a>服务调用出现的问题</h3><ul>
<li>服务消费者该如何获取服务提供者的地址信息？</li>
<li>如果有多个服务提供者，消费者该如何选择？</li>
<li>消费者如何得知服务提供者的健康状态？</li>
</ul>
<h3 id="EureKa的作用"><a href="#EureKa的作用" class="headerlink" title="EureKa的作用"></a>EureKa的作用</h3><p>在Eureka架构中，微服务角色有两类：</p>
<ol>
<li>EurekaServer：服务端，注册中心<ul>
<li>记录服务信息</li>
<li>心跳监控</li>
</ul>
</li>
<li>EurekaClient：客户端<ul>
<li>Provider：服务提供者，例如案例中的user-service<ol>
<li>注册自己的信息到EurekaServer</li>
<li>每隔30秒向EurekaServer发送心跳</li>
</ol>
</li>
<li>consumer：服务消费者，例如案例中的order-service<ol>
<li>根据服务名称从EurekaServer拉取服务列表</li>
<li>基于服务列表做负载均衡，选中一个微服务后发起远程调用</li>
</ol>
</li>
</ul>
</li>
</ol>
<p>具体问题：</p>
<ul>
<li>消费者该如何获取服务提供者具体信息？<ol>
<li>服务提供者启动时向eureka注册自己的信息</li>
<li>eureka保存这些信息</li>
<li>消费者根据服务名称向eureka拉取提供者信息</li>
</ol>
</li>
<li>如果有多个服务提供者，消费者该如何选择？<ol>
<li>服务消费者利用负载均衡算法，从服务列表中挑选一个</li>
</ol>
</li>
<li>消费者如何感知服务提供者的健康状态？<ol>
<li>服务提供者会每隔30秒向eurekaserver发送心跳请求，报告健康状态</li>
<li>eureka会更新记录服务器列表信息，心跳不正常会被剔除</li>
<li>消费者就可以拉取到最新的消息</li>
</ol>
</li>
</ul>
<h3 id="搭建EurekaServer"><a href="#搭建EurekaServer" class="headerlink" title="搭建EurekaServer"></a>搭建EurekaServer</h3><p>搭建EurekaServer服务步骤如下：</p>
<ol>
<li><p>创建项目，引入spring-cloud-starter-netflix-eureka-server的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org,springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifacrId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifacrId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
</li>
<li><p>编写启动类，添加@EnableEurekaServer注解</p>
</li>
<li><p>添加application.yml文件，编写下面的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> <span class="comment">#端口</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8084</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span> <span class="comment">#服务名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaServer</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment">#eureka的地址信息</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:8084/eureka</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>服务注册步骤</p>
<ol>
<li><p>在要注册的服务下引入spring-cloud-starter-netflix-eureka-client</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org,springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifacrId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifacrId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在application.yml文件添加</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> <span class="comment">#端口</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span> <span class="comment">#服务名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">UserService</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span> <span class="comment">#eureka的地址信息</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:8084/eureka</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>代码请求地址中将ip和端口号改为eureka的服务名,并给restTemplate添加@loadBanlanced开启负载均衡</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><h4 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h4><h5 id="负载均衡原理"><a href="#负载均衡原理" class="headerlink" title="负载均衡原理"></a>负载均衡原理</h5><p>ribbon通过获取主机名来对eureka进行获取服务地址，然后通过轮询或者随机来完成负载均衡</p>
<h5 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h5><table>
<thead>
<tr>
<th align="left">内置负载均衡规则类</th>
<th>规则描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">RoundRobinRule</td>
<td>简单轮询服务列表来选择服务器。他是Ribbon默认的负载均很规则</td>
</tr>
<tr>
<td align="left">AvailablitityFilteringRule</td>
<td>对以下两种服务器进行忽略：（1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”转台。短路状态将持续30秒，如果再次连接失败，短路的持续 时间就会几何级数的增加。（2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilterRule规则的客户端也会将其忽略。并发连接数的上线可以由客户端的<clientName><vlientConfigNameSpace>.ActiveConnectionsLimit属性进行配置</vlientConfigNameSpace></clientName></td>
</tr>
<tr>
<td align="left">weightedResponseTimeRule</td>
<td>为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。</td>
</tr>
<tr>
<td align="left">BestAvailableRule</td>
<td>忽略那些短路的服务器，并选择并发数较低的服务器</td>
</tr>
<tr>
<td align="left">ZoneAvailableRule</td>
<td>以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个几架等。而后再对Zone的多个服务做轮询</td>
</tr>
<tr>
<td align="left">RandomRule</td>
<td>随机选择一个可用的服务器</td>
</tr>
<tr>
<td align="left">RetryRule</td>
<td>重试机制的选择逻辑</td>
</tr>
</tbody></table>
<p>通过定义IRule实现可以修改负载均衡规则，有两种方式：</p>
<p>1、代码方式在配置类中定义一个新的IRule：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">randomRule</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1、配置文件方式：yml文件中添加新的配置也可以修改规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">	<span class="attr">ribbon:</span></span><br><span class="line">		<span class="string">NFLoadBalancerRuleClassName:com.netflix.loadbalancer.RandomRule</span>  <span class="comment">#负载均衡规则</span></span><br></pre></td></tr></table></figure>



<h5 id="饥饿加载"><a href="#饥饿加载" class="headerlink" title="饥饿加载"></a>饥饿加载</h5><p>Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ribbon:</span><br><span class="line">	eager-load:</span><br><span class="line">		enabled: true #开启饥饿加载</span><br><span class="line">		clients: </span><br><span class="line">			-userservice #指定对userservice这个服务饥饿加载</span><br><span class="line">			-xxservice</span><br></pre></td></tr></table></figure>

<h2 id="Nacos注册中心"><a href="#Nacos注册中心" class="headerlink" title="Nacos注册中心"></a>Nacos注册中心</h2><h3 id="认识和安装Nacos"><a href="#认识和安装Nacos" class="headerlink" title="认识和安装Nacos"></a>认识和安装Nacos</h3><p>Nacos是阿里巴巴的产品，现在是SpringCloud中的一个组件。相比Eureka功能更加丰富，在国内受欢迎程度较高。</p>
<h4 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h4><ol>
<li>安装nacos</li>
<li>nacos默认端口：8848，修改端口在application.properties</li>
<li>nacos启动命令:startup.cmd -m standalone</li>
<li>登录名和密码都为nacos</li>
</ol>
<h3 id="服务注册到Nacos"><a href="#服务注册到Nacos" class="headerlink" title="服务注册到Nacos"></a>服务注册到Nacos</h3><ol>
<li><p>在cloud-demo父工程中添加spring-cloud-alibaba的管理依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artfactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artfactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注释掉order-service和user-service中原有的eureka依赖</p>
</li>
<li><p>添加nacos的客户端依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependecy</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artfactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artfactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependecy</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改user-service和order-service中的application.yml文件，注释eureka地址，添加nacos地址：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">	cloud:</span><br><span class="line">		nacos:</span><br><span class="line">			server-addr: localhost:8848 #nacos  服务端地址</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动并测试</p>
</li>
</ol>
<h3 id="nacos服务分级存储模型"><a href="#nacos服务分级存储模型" class="headerlink" title="nacos服务分级存储模型"></a>nacos服务分级存储模型</h3><p>一个服务的多个实例分开放</p>
<ol>
<li><p>修改application.yml文件，添加以下内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">server-addr:</span> <span class="comment">#nacos  服务端地址</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">cluster-name:</span> <span class="string">HZ</span> <span class="comment">#配置集群名称，也就是机房位置，例如：HZ，杭州</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>1、Nacos服务分级存储模型：</p>
<ul>
<li>一级是服务，例如userservice</li>
<li>二级是集群，例如杭州或上海</li>
<li>三级是实例，例如杭州机房的某台部署了userservice的服务器</li>
</ul>
<p>2、如何设置实例的集群属性</p>
<ul>
<li>修改application.yml文件，添加spring.cloud.nacos.discovery.cluster-name属性即可</li>
</ul>
<h4 id="根据集群负载均衡"><a href="#根据集群负载均衡" class="headerlink" title="根据集群负载均衡"></a>根据集群负载均衡</h4><ol>
<li><p>修改order-service中的application.yml，设置集群为HZ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">server-addr:</span> <span class="string">localhost:8848</span>  <span class="comment">#nacos服务器地址</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">cluster-name:</span> <span class="string">HZ</span> <span class="comment">#配置集群名称，也就是机房位置</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后再order-service中设置负载均衡的Rule为NacosRule，这个规则会优先寻找与自己同集群的服务:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">	<span class="attr">ribbon:</span></span><br><span class="line">		<span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.alibaba.cloud.nacos.ribbon.NacosRule</span> <span class="comment">#负载均衡策略</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注意将user-service的权重都设置为1</p>
</li>
</ol>
<h4 id="根据权重负载均衡"><a href="#根据权重负载均衡" class="headerlink" title="根据权重负载均衡"></a>根据权重负载均衡</h4><p>实际部署中会出现这样的场景：</p>
<ul>
<li>服务器设备性能有差异，部分实例所在及其性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求</li>
</ul>
<p>nacos提供了权重配置来控制访问频率，权重越大则访问频率越高</p>
<ol>
<li>在nacos控制台可以设置实例的权重值，首先选中实例后面的编辑按钮</li>
<li>将权重设置为0.1，则该实例被访问到的概率将大大降低</li>
</ol>
<p>总结：</p>
<ol>
<li>nacos控制台可以设置实例的权重值，0-1之间</li>
<li>同集群内的多个实例，权重越高被访问的频率越高</li>
<li>权重设置为0则完全不会被访问（可以做项目的平滑升级）</li>
</ol>
<h3 id="环境隔离-namespace"><a href="#环境隔离-namespace" class="headerlink" title="环境隔离-namespace"></a>环境隔离-namespace</h3><p>nacos中服务存储和数据存储的最外层都是一个名为namespace的东西，用来做最外层隔离</p>
<p>步骤：</p>
<ol>
<li><p>在nacos控制台中的命名空间添加命名空间</p>
</li>
<li><p>在要隔离的yml文件中添加namespace</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">cluster-name:</span> <span class="string">SH</span></span><br><span class="line">				<span class="attr">namespace:</span> <span class="string">命名空间id</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>总结：</p>
<ol>
<li>namespzce用来做环境隔离</li>
<li>每个namespace都有唯一id</li>
<li>不同namespace下的服务不可见</li>
</ol>
<h3 id="Nacos与eureka的区别"><a href="#Nacos与eureka的区别" class="headerlink" title="Nacos与eureka的区别"></a>Nacos与eureka的区别</h3><ol>
<li>Nacos与eureka的共同点<ul>
<li>都支持服务注册和服务拉取</li>
<li>都支持服务提供者心跳方式做健康检测</li>
</ul>
</li>
<li>Nacos与Eureka的区别<ul>
<li>nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</li>
<li>临时实例心跳不正常会被剔除，非临时实例则不会被剔除</li>
<li>nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li>
<li>nacos集群默认采用ap方式，当集群中存在非临时实例时，采用cp模式；eureka采用ap方式</li>
</ul>
</li>
</ol>
<p>服务注册到nacos时，可以选择注册为临时或非临时实例，通过下面的配置来设置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">nacos:</span></span><br><span class="line">			<span class="attr">discovery:</span></span><br><span class="line">				<span class="attr">ephemeral:</span> <span class="literal">false</span>  <span class="comment">#设置是否为临时实例</span></span><br></pre></td></tr></table></figure>

<h2 id="Nacos配置管理"><a href="#Nacos配置管理" class="headerlink" title="Nacos配置管理"></a>Nacos配置管理</h2><h3 id="统一配置管理"><a href="#统一配置管理" class="headerlink" title="统一配置管理"></a>统一配置管理</h3><ol>
<li>在nacos中添加配置信息</li>
<li>在弹出的表单中填写配置信息<ul>
<li>配置文件的id：[服务名称]-[profile].后缀名</li>
<li>分组  默认即可</li>
<li>格式  目前支持yaml  和properties</li>
<li>完成</li>
</ul>
</li>
<li>最好只配置需要热更新的配置</li>
</ol>
<h3 id="微服务配置拉取"><a href="#微服务配置拉取" class="headerlink" title="微服务配置拉取"></a>微服务配置拉取</h3><ol>
<li><p>在nacos中添加配置文件</p>
</li>
<li><p>在微服务中引入nacos的config依赖</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;!--导入nacos配置依赖--&gt;</span></span><br><span class="line">        <span class="string">&lt;dependency&gt;</span></span><br><span class="line">            <span class="string">&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span><br><span class="line">            <span class="string">&lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span></span><br><span class="line">        <span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在微服务中添加bootstrap.yml(引导文件，优先级高于application.yml)，配置nacos地址、当前环境、服务名称、文件后缀名。这些决定了程序启动时去nacos读取那个文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span> <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment">#开发环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#文件后缀名</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>@refreshScope注解   热更新自动刷新注解   在需要自动注入的地方使用</p>
</li>
</ol>
<p>nacos配置更改后，微服务可以实现热更新，方式：</p>
<ol>
<li>通过@value注解注入，结合@refreshScope来刷新</li>
<li>通过@ConfigurationProperties注入，自动刷新</li>
</ol>
<p>注意事项：</p>
<ul>
<li>不是所有的配置都适合放到配置中心，维护起来比较麻烦</li>
<li>建议将一些关键参数，需要运行时调整的参数放到nacos配置中心，一般都是自定义配置</li>
</ul>
<h3 id="多环境配置共享"><a href="#多环境配置共享" class="headerlink" title="多环境配置共享"></a>多环境配置共享</h3><p>微服务启动时会从nacos读取多个配置文件：</p>
<ul>
<li>[spring.application.name]-[spring.profiles.active].yaml，例如：userservice-dev.yaml</li>
<li>[spring.application.name.yaml].yaml，例如：userservice.yaml</li>
</ul>
<p>无论profile如何变化,[spring.application.name.yaml].yaml这个文件一定会加载，因此多环境共享配置可以写入这个文件</p>
<p>多种配置的优先级：</p>
<ul>
<li>服务名-profile.yaml &gt; 服务名称.yaml  &gt;  本地配置</li>
</ul>
<h3 id="Nacos集群搭建"><a href="#Nacos集群搭建" class="headerlink" title="Nacos集群搭建"></a>Nacos集群搭建</h3><p>nacos生产环境下一定要部署为集群状态</p>
<ol>
<li><p>配置nacos</p>
<p>配置三份nacos节点</p>
<ul>
<li><p>进入nacos的conf目录，修改配制文件cluster.conf.example，重命名为cluster.conf</p>
</li>
<li><p>添加内容：</p>
<p>127.0.0.1:8845</p>
<p>127.0.0.1:8846</p>
<p>127.0.0.1:8847</p>
</li>
</ul>
</li>
<li><p>将nacos文件夹复制三分，分别命名为：nacos1、nacos2、nacos3</p>
<ul>
<li><p>然后分别修改三个文件夹中的application.properties</p>
<p>server.port&#x3D;8845</p>
<p>server.port&#x3D;8846</p>
<p>server.port&#x3D;8847</p>
</li>
</ul>
</li>
<li><p>分别启动三个nacos节点</p>
</li>
<li><p>nginx反向代理</p>
<ul>
<li><p>修改conf&#x2F;nginx.conf文件，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream nacos-cluster &#123;</span><br><span class="line">	server 127.0.0.1:8845;</span><br><span class="line">	server 127.0.0.1:8846;</span><br><span class="line">	server 127.0.0.1:8847;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen	80;</span><br><span class="line">	server_name	localhost;</span><br><span class="line">	</span><br><span class="line">	location /nacos &#123;</span><br><span class="line">		proxy_pass http://nacos-cluster;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>将nacos中的连接数据库打开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.platform=mysql</span><br><span class="line">db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="line">db.user.0=root</span><br><span class="line">db.password.0=rose</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动</p>
</li>
</ol>
<h2 id="http客户端Feign"><a href="#http客户端Feign" class="headerlink" title="http客户端Feign"></a>http客户端Feign</h2><h3 id="RestTemplate方式调用存在的问题"><a href="#RestTemplate方式调用存在的问题" class="headerlink" title="RestTemplate方式调用存在的问题"></a>RestTemplate方式调用存在的问题</h3><p>先来看我们以前利用RestTemplate发起远程调用的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span><span class="string">&quot; http://userservice/user/&quot;</span>+order.getuserId();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(url,User.class)</span><br></pre></td></tr></table></figure>

<p>​	存在下面的问题：</p>
<ul>
<li>代码可读性差，编程体验不统一</li>
<li>参数复杂URL难以维护</li>
</ul>
<h3 id="Feign的介绍"><a href="#Feign的介绍" class="headerlink" title="Feign的介绍"></a>Feign的介绍</h3><p>Feign是一个声明式的http客户端，官方地址：<a target="_blank" rel="noopener" href="http://github.com/OpenFeign/feign">http://github.com/OpenFeign/feign</a> 其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题</p>
<p>使用步骤：</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--导入feign依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在order-service的启动类添加注解开启Feign的功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;cn.itcast.order.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;    SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写Feign客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="自定义Feign的配置"><a href="#自定义Feign的配置" class="headerlink" title="自定义Feign的配置"></a>自定义Feign的配置</h3><p>Feign运行自定义配置来覆盖默认配置，可以修改的配置如下</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>feign.Logger.Level</td>
<td>修改日志级别</td>
<td>包含四种不同的级别：NON、BASIC、HEADERS、FULL</td>
</tr>
<tr>
<td>feign.codec.Decoder</td>
<td>响应结果的解析器</td>
<td>http远程调用的结果做解析，例如解析json字符串为java对象</td>
</tr>
<tr>
<td>feign.codec.Encoder</td>
<td>请求参数编码</td>
<td>将请求参数编码，便于通过http请求发送</td>
</tr>
<tr>
<td>feign.Contract</td>
<td>支持的注解格式</td>
<td>默认是SpringMVC的注解</td>
</tr>
<tr>
<td>feign.Retryer</td>
<td>失败重试机制</td>
<td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td>
</tr>
</tbody></table>
<p>一般我们需要配置的就是日志级别</p>
<p>自定义Feign的配置有两种方式：</p>
<p>方式一：配置文件方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">	<span class="attr">client:</span></span><br><span class="line">		<span class="attr">config:</span></span><br><span class="line">			<span class="attr">default:</span>  <span class="comment">#这里用default就是全局配置  </span></span><br><span class="line">				<span class="attr">loggerLevel:</span> <span class="string">Full</span>  <span class="comment">#日志级别</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">	<span class="attr">client:</span></span><br><span class="line">		<span class="attr">config:</span></span><br><span class="line">			<span class="attr">userservice:</span>  <span class="comment">#这里用userservice就是只有某个微服务配置</span></span><br><span class="line">				<span class="attr">loggerLevel:</span> <span class="string">Full</span>  <span class="comment">#日志级别</span></span><br></pre></td></tr></table></figure>

<p>方式二：Java代码方式，需要先声明一个bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientConfiguration</span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> Logger.Level <span class="title function_">feignLogLevel</span><span class="params">()</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Logger.Level.BASIC;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>而后如果是全局配置，则把它放到@EnableFeignClient这个注解中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = FeignClientConfiguration.class)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果是局部配置，则把他放到@FeignClient这个注解中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@feignClient(value = &quot;userservice&quot;,configuration=FeignClientConfiguration.class)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Feign的性能优化"><a href="#Feign的性能优化" class="headerlink" title="Feign的性能优化"></a>Feign的性能优化</h3><p>Feign底层的客户端实现：</p>
<ul>
<li>URLConnection：默认实现，不支持连接池</li>
<li>Apache Httpclient:支持连接池</li>
<li>OKHTTP：支持连接池</li>
</ul>
<p>因此优化Feign的性能主要包括：</p>
<ol>
<li>使用连接池代替默认的URLConnection</li>
<li>日志级别，最好用basic或none</li>
</ol>
<p>步骤：</p>
<ol>
<li><p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入HttpClient依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Feign的最佳实践"><a href="#Feign的最佳实践" class="headerlink" title="Feign的最佳实践"></a>Feign的最佳实践</h3><h4 id="方式一（继承）："><a href="#方式一（继承）：" class="headerlink" title="方式一（继承）："></a>方式一（继承）：</h4><p>给消费者的FeignClient和提供者的controller定义统一的父接口作为标准</p>
<p>因为消费者的feignClient和提供者的controller的方法名和参数以及请求方式都相似，所以可以把他们抽取出来定义一个父类  让他们来继承 ，这样 他们就都不用写了。但这样他们的耦合性就高了</p>
<h4 id="方式二（抽取）："><a href="#方式二（抽取）：" class="headerlink" title="方式二（抽取）："></a>方式二（抽取）：</h4><p>将FeignCilent抽取为独立模块，并且把接口端的POJO、默认的Feign配置都放到这个模块中，提供给所有消费者使用</p>
<p>因为服务的消费者用的userCilent有很多消费者在用，我们把userclient抽取出来（包括实体类，默认配置等），让消费者来医用依赖，然后远程调用服务的提供者。</p>
<h4 id="实现最佳实现方式二"><a href="#实现最佳实现方式二" class="headerlink" title="实现最佳实现方式二"></a>实现最佳实现方式二</h4><ol>
<li>首先创建一个module，命名为feign-api，然后引入feign的starter依赖</li>
<li>将order-service中编写的UserClient、User、DefaultFeignConfiguration都复制到feign-api项目中</li>
<li>在order-service中引入feign-api的依赖</li>
<li>修改order-service中的所有与上述三个组件有关的import部分，改成导入feign-api中的包</li>
</ol>
<p>当定义FeignClient不在SpringBootApplication的扫描包范围时，这些FeignClient无法使用。有两种解决方案：</p>
<ol>
<li><p>方式一：指定FeignClient所在包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages=&quot;cn.itcast.feign.clients&quot;)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：指定FeignClient字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(clients = &#123;UserClient.class&#125;)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="GateWay网关"><a href="#GateWay网关" class="headerlink" title="GateWay网关"></a>GateWay网关</h2><p>为什么需要网关？</p>
<p>微服务先注册到nacos，微服务与微服务之间通过feign来调用，用户需要操作时直接发请求到微服务，但这时候就存在一个问题，我们的微服务就在那里让所有人访问这是不安全的，因为有些业务属于公司内部的不需要面向大众，所以就需要对用户的身份进行验证。所以gateway网关就是专门做这个的。验证完后是不是需要放行到微服务去那？所以网关还需要将请求转发到微服务，也就是服务路由，并且网关还做到了负载均衡，因为一个查询请求对应的微服务可能偶多个实例。网关还可以请求限流</p>
<h3 id="网关的功能："><a href="#网关的功能：" class="headerlink" title="网关的功能："></a>网关的功能：</h3><ul>
<li>身份验证和权限校验。</li>
<li>服务路由和负载均衡</li>
<li>请求限流</li>
</ul>
<h3 id="网关的技术实现"><a href="#网关的技术实现" class="headerlink" title="网关的技术实现"></a>网关的技术实现</h3><ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<p>zuul是基于servlet的实现，属于阻塞式编程。而SpringcloudGateway是基于Spring5中提供的webFlux，属于响应式编程的实现，具备更好的性能。</p>
<h3 id="搭建网关服务"><a href="#搭建网关服务" class="headerlink" title="搭建网关服务"></a>搭建网关服务</h3><p>步骤：</p>
<ol>
<li><p>创建新的mouble，引入SpringCloudGateWay的依赖和nacos的服务发现依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacos的服务发现依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--网关依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写路由配置及nacos地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span>  <span class="comment">#服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span>  <span class="comment">#nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment">#网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span>  <span class="comment">#路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span>  <span class="comment">#路由的目标地址，lb就是负载均衡  后面跟着服务名</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment">#这是按照路径匹配 也就是/user/开头就符合要求</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://orderservice</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span> <span class="comment">#网关端口</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>总结：</p>
<ol>
<li><p>创建项目，引入nacos服务发现和gateway依赖</p>
</li>
<li><p>配置application.yml，包括服务基本信息、nacos地址、路由</p>
<p>路由配置包括：</p>
<ul>
<li>路由id：路由的唯一标识</li>
<li>路由目标（uri）：路由的目标地址、http代表固定地址，lb代表根据服务名负载均衡</li>
<li>路由断言(prediscates):判断路由的规则</li>
<li>路由过滤器(filters):对请求或响应做处理</li>
</ul>
</li>
</ol>
<h3 id="路由断言工厂RoutePredicateFactory"><a href="#路由断言工厂RoutePredicateFactory" class="headerlink" title="路由断言工厂RoutePredicateFactory"></a>路由断言工厂RoutePredicateFactory</h3><p>spring提供了11种基本的predicate工厂：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>After</td>
<td>是某个时间点之后的请求</td>
<td>-Afer&#x3D;2023-01-20T17:42:47.789-07:00[America&#x2F;Denver]</td>
</tr>
<tr>
<td>Before</td>
<td>是某个时间点之前的请求</td>
<td>-Afer&#x3D;2023-01-20T17:42:47.789-07:00[America&#x2F;Denver]</td>
</tr>
<tr>
<td>Between</td>
<td>是某两个之间点之间的请求</td>
<td>-Between&#x3D;2023-01-20T17:42:47.789-07:00[America&#x2F;Denver],023-01-20T17:42:47.789-07:00[America&#x2F;Denver]</td>
</tr>
<tr>
<td>Cookid</td>
<td>请求必须包含某些cookie</td>
<td>-Cookid&#x3D;chocolata,ch.p</td>
</tr>
<tr>
<td>Header</td>
<td>请求必须包含某些header</td>
<td>-Header&#x3D;X-Request-Id,\d+</td>
</tr>
<tr>
<td>Host</td>
<td>请求必须是访问某个host（域名）</td>
<td>-Host&#x3D;<strong>.somehost.org,</strong>.anotherhost.org</td>
</tr>
<tr>
<td>Method</td>
<td>请求方式必须是指定方式</td>
<td>-Method&#x3D;GET,POST</td>
</tr>
<tr>
<td>Path</td>
<td>请求路径必须符合指定规则</td>
<td>-Path&#x3D;&#x2F;red&#x2F;{segment},&#x2F;blue&#x2F;**</td>
</tr>
<tr>
<td>Query</td>
<td>请求参数必须包含指定参数</td>
<td>-Query&#x3D;name,Jack或者-Query&#x3D;name</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>请求者的ip必须是指定范围</td>
<td>-ReomteAdr&#x3D;192.168.1.1&#x2F;24</td>
</tr>
<tr>
<td>Weight</td>
<td>权重处理</td>
<td></td>
</tr>
</tbody></table>
<h3 id="路由过滤器GatewayFilter"><a href="#路由过滤器GatewayFilter" class="headerlink" title="路由过滤器GatewayFilter"></a>路由过滤器GatewayFilter</h3><p>GatewayFilter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理：</p>
<p>spring提供了31种不同的路由过滤器工厂：看例如：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AddrequestHeader</td>
<td>给当前请求添加一个请求头</td>
</tr>
<tr>
<td>RemoveRequestHeader</td>
<td>移除请求中的一个请求头</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>给响应结果中添加一个响应头</td>
</tr>
<tr>
<td>RemoveResponseHeader</td>
<td>从响应结果中移除一个响应头</td>
</tr>
<tr>
<td>RequestRateLimiter</td>
<td>限制请求的流量</td>
</tr>
</tbody></table>
<p>给所有进入userservice的请求添加一个请求头：Truth&#x3D;rosevvi fucking awesome!</p>
<p>实现方式：在gateway中修改application.yml文件，给userserivice的路由添加过滤器:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span> <span class="comment">#网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span>  <span class="comment">#路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span>  <span class="comment">#路由的目标地址，lb就是负载均衡  后面跟着服务名</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment">#这是按照路径匹配 也就是/user/开头就符合要求</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=Truth,rosevvi</span> <span class="string">is</span> <span class="string">fucking</span> <span class="string">rwesome!!!</span></span><br></pre></td></tr></table></figure>

<p>如果要对所有的路由都生效，则可以将过滤器工厂的default下。格式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">      <span class="attr">routes:</span> <span class="comment">#网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span>  <span class="comment">#路由id，自定义，只要唯一即可</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://userservice</span>  <span class="comment">#路由的目标地址，lb就是负载均衡  后面跟着服务名</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#路由断言，也就是判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment">#这是按照路径匹配 也就是/user/开头就符合要求</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - AddRequestHeader=Truth,rosevvi is fucking rwesome!!!</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://orderservice</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/**</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=Truth,rosevvi</span> <span class="string">is</span> <span class="string">fucking</span> <span class="string">rwesome!!!</span></span><br></pre></td></tr></table></figure>

<h3 id="全局过滤器GlobleFilter"><a href="#全局过滤器GlobleFilter" class="headerlink" title="全局过滤器GlobleFilter"></a>全局过滤器GlobleFilter</h3><p>全局过滤器的作用也是处理一切网关的请求和微服务响应，与fatewayFilter的作用一样。区别在于GatewayFilter通过配置定义，处理逻辑是固定的。而GlobalFilter的逻辑需要自己写代码实现</p>
<p>定义方式是实现FlobalFilter接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置优先级  或者实现Ordered接口</span></span><br><span class="line"><span class="meta">@Order(-1)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">//1、获取请求参数</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">//2、获取参数中的Authorization参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">auth</span> <span class="operator">=</span> request.getQueryParams().getFirst(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="comment">//3、判断参数值是否为admin</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(auth))&#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4、拦截  设置状态码</span></span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        <span class="comment">//5、拦截请求</span></span><br><span class="line">        <span class="keyword">return</span>  exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤器的执行顺序"><a href="#过滤器的执行顺序" class="headerlink" title="过滤器的执行顺序"></a>过滤器的执行顺序</h4><ul>
<li>每一个过滤器都必须指定一个int类型的order值，order值越小，优先级越高，执行顺序越靠前。</li>
<li>GlobalFilter通过实现Order接口，或者添加@Order注解来指定order值，有我们自己指定</li>
<li>路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增。</li>
<li>当过滤器的order值一样时，会按照defaultFilter&gt;路由过滤器&gt;GlobalFilter的顺序执行。</li>
</ul>
<h3 id="网关跨域问题处理"><a href="#网关跨域问题处理" class="headerlink" title="网关跨域问题处理"></a>网关跨域问题处理</h3><p>跨域：域名不一致就是跨域，主要包括</p>
<ul>
<li>域名不同：<a target="_blank" rel="noopener" href="http://www.taobao.com和www.taobao.org和www.jd.com和miaosha.jd.com/">www.taobao.com和www.taobao.org和www.jd.com和miaosha.jd.com</a></li>
<li>域名相同，端口不容：localhost:8080和localhost:8081</li>
</ul>
<p>跨域问题：浏览器禁止请求的发起者与服务端跨域ajax请求，请求被浏览器拦截问题。</p>
<p>解决方案：CORS</p>
<p>网关处理跨域采用的同样是CORS方案，并且只需要简单配置即可实现：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span> <span class="comment">#全局的跨域处理</span></span><br><span class="line">        <span class="attr">add-to-simple-url-handler-mapping:</span> <span class="literal">true</span>  <span class="comment">#解决options请求被拦截</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment">#拦截那些请求</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span>  <span class="comment">#允许那些网站的跨域请求</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://localhost:8090&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://www.leyou.com&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span>  <span class="comment">#允许的跨域ajax的请求方式</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;DELETE&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;PUT&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;OPTIONS&quot;</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&quot;*&quot;</span> <span class="comment">#允许在请求头中携带的头信息</span></span><br><span class="line">            <span class="attr">allowCredentials:</span> <span class="literal">true</span> <span class="comment">#是否允许携带cookid</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">360000</span> <span class="comment">#这次跨域检测的有效期</span></span><br></pre></td></tr></table></figure>

<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>项目部署的问题</p>
<p>大型项目组件较多，运行环境也较为复杂，部署时会碰到一些问题：</p>
<ul>
<li>依赖关系复杂，容易出现兼容性问题</li>
<li>开发、测试、生产环境有差异</li>
</ul>
<p>Docker如何解决依赖的兼容问题的？</p>
<ul>
<li>将应用的libs（函数库）、Deps（依赖）、配置与应用一起打包</li>
<li>将每个应用放到一个隔离容器去运行，避免互相干扰</li>
</ul>
<p>Docker如何解决不同系统环境的问题？</p>
<ul>
<li>Docker将用户程序与所需要调用的系统（比如Centos）函数库一起打包，这样它只要基于linux内核就可以运行</li>
<li>Docker运行到不同操作系统时，直接基于打包的库函数，借助于操作系统的linux内核来运行</li>
</ul>
<h3 id="Docker和虚拟机的差异："><a href="#Docker和虚拟机的差异：" class="headerlink" title="Docker和虚拟机的差异："></a>Docker和虚拟机的差异：</h3><ul>
<li>docker是一个系统进程；虚拟机是在操作系统中的操作系统</li>
<li>docker体积小、启动速度快、性能好；虚拟机体积大、启动速度慢、性能一般</li>
</ul>
<h3 id="Docker架构"><a href="#Docker架构" class="headerlink" title="Docker架构"></a>Docker架构</h3><p>镜像（Image）：Docker将应用程序以及其所需要的依赖、环境、配置等文件打包在一起，称为镜像。</p>
<p>容器（Container）：镜像中的应用程序运行后形成的进程就是容器，只是Docker会给容器做隔离，使其互相对外不可见。</p>
<p>DockerHub：DockerHub是一个Docker镜像的托管平台。这样的怕平台称为DockerRegistry。</p>
<p>Docker是一个CS架构的程序，由两部分组成：</p>
<ul>
<li>服务端（server):Docker守护进程，负责处理Docker指令，管理镜像、容器等</li>
<li>客户端（client）：通过命令或RestApi向Docker服务端发送指令。可以在本地或远程向服务器发送指令</li>
</ul>
<h3 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h3><h4 id="常用命令："><a href="#常用命令：" class="headerlink" title="常用命令："></a>常用命令：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">镜像命令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁止开机启动防火墙</span></span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker版本</span></span><br><span class="line">docker -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止docker 服务</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker 服务</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看本地镜像</span></span><br><span class="line">docker images</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像 没有版本 默认最新版</span></span><br><span class="line">docker pull nginx:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送镜像</span> </span><br><span class="line">docker push</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除一个本地镜像</span></span><br><span class="line">docker rmi nginx:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看帮助</span></span><br><span class="line">docker save --help</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用dockers save将nginx镜像导出到磁盘，然后再通过load加载回来  docker save [options] image [image]...</span></span><br><span class="line">docker save -o nginx.tar nginx:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用load加载镜像</span></span><br><span class="line">docker load -i nginx.tar</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">构建镜像  自定义镜像  -t指定dockerfile所在目录 空格点.</span></span><br><span class="line">docker build -t</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器常用命令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行  --name：给容器起名字   -p：将宿主机端口与容器端口映射，冒号左边是宿主机端口，右侧是容器端口  80:80  -d：后台运行容器 nginx：基于nginx镜像创建的</span></span><br><span class="line">docker run  --name containerName -p 80:80 -d nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂停</span></span><br><span class="line">docker pause</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开始</span></span><br><span class="line">docker unpause</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止</span></span><br><span class="line">docker stop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开始</span></span><br><span class="line">docker start</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有运行的容器及状态  -a查看所有状态的容器</span></span><br><span class="line">docker ps -a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看容器运行日志 docker logs [name] -f   -f：持续输出日志</span></span><br><span class="line">docker logs mn</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入容器执行命令   要执行的命令通常为bash</span></span><br><span class="line">docker exec -it [容器名][要执行的命令]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除指定容器 -f强制删除运行中的容器</span></span><br><span class="line">docker rm -f</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">数据卷命令</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">数据卷操作命令的基本语法</span></span><br><span class="line">docker volume [COMMAND]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个volume</span></span><br><span class="line">docker volume create</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">显示一个或多个volume的信息</span></span><br><span class="line">docker volume inspect</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">列出所有的volume</span></span><br><span class="line">docker volume ls</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除未使用的volume</span></span><br><span class="line">docker volume prune</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除一个或多个指定的volume</span></span><br><span class="line">docker volume rm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">数据卷挂载</span></span><br><span class="line">docker run --name mn -v html:/root/html -p 8080:80 nginx</span><br></pre></td></tr></table></figure>





<h4 id="1-CentOs安装Docker"><a href="#1-CentOs安装Docker" class="headerlink" title="1.CentOs安装Docker"></a>1.CentOs安装Docker</h4><p>DockerCE支持64位版本的Centos7，并且要求内核版本不低于3.10，Centos7满足最低内核要求，所以我们在Centos7上安装Docker</p>
<h4 id="1-1卸载（可选）"><a href="#1-1卸载（可选）" class="headerlink" title="1.1卸载（可选）"></a>1.1卸载（可选）</h4><p>如果之间安装过旧版本的Docker，可以使用下面命令卸载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum  remove docker \</span><br><span class="line">    docker-client \</span><br><span class="line">    docker-client-latest \</span><br><span class="line">    docker-common \</span><br><span class="line">    docker-latest \</span><br><span class="line">    docker-latest=logrotate \</span><br><span class="line">    docker-logroate \</span><br><span class="line">    docker-selinux \</span><br><span class="line">    docker-engine-selinux \</span><br><span class="line">    docker-enfine \</span><br><span class="line">    docker -ce </span><br></pre></td></tr></table></figure>

<h4 id="1-2-安装Docker"><a href="#1-2-安装Docker" class="headerlink" title="1.2 安装Docker"></a>1.2 安装Docker</h4><p>首先要联网虚拟机，安装yum工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">    device=mapper-persistent-data \</span><br><span class="line">    lvn2 --skip-broken\</span><br></pre></td></tr></table></figure>

<p>更新本地镜像源：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置Docker镜像源</span></span><br><span class="line">yum-config-manger \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sed -i &#x27;s/download.docker.com/mirrors.aliyun.com\/docker-ce/g&#x27;</span><br><span class="line">/etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum makecache fast</span><br></pre></td></tr></table></figure>

<p>然后输入命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce</span><br></pre></td></tr></table></figure>

<p>稍等就安装完成了</p>
<h4 id="1-3-启动docker"><a href="#1-3-启动docker" class="headerlink" title="1.3 启动docker"></a>1.3 启动docker</h4><p>Docker应用需要用到各种端口，逐一去修改防护墙设置非常麻烦，建议关闭防火墙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁止开机启动防火墙</span></span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker版本</span></span><br><span class="line">docker -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止docker 服务</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker 服务</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="1-4-配置镜像"><a href="#1-4-配置镜像" class="headerlink" title="1.4 配置镜像"></a>1.4 配置镜像</h4><p>docker官方镜像仓库网速较差，我们需要设置国内镜像</p>
<p>参考阿里云的镜像加速文档：<a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://u2fv9qvc.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="容器练习"><a href="#容器练习" class="headerlink" title="容器练习"></a>容器练习</h3><p>进入nginx容器，修改html文件内容，添加“船只教育观影你”</p>
<ol>
<li><p>进入容器。进入我们刚创建的nginx的容器命令为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mn bash</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>命令解读：</p>
<ul>
<li>docker exec：进入容器内部，执行一个命令</li>
<li>-it：给当前进入的容器创建一个标准输入、输出终端，允许我们与容器交互</li>
<li>mn：要进入的容器的名称</li>
<li>bash：进入容器后执行的命令，bash是一个linux终端交互命令</li>
</ul>
</li>
</ol>
<h3 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h3><p>数据卷（volume）是一个虚拟目录，指向宿主机文件系统中的某个目录（&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes），创建一个数据卷html那么他就会创建&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;html</p>
<p>数据卷操作命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">数据卷操作命令的基本语法</span></span><br><span class="line">docker volume [COMMAND]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建一个volume</span></span><br><span class="line">docker volume create [name]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">显示一个或多个volume的信息</span></span><br><span class="line">docker volume inspect</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">列出所有的volume</span></span><br><span class="line">docker volume ls</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除未使用的volume</span></span><br><span class="line">docker volume prune</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除一个或多个指定的volume</span></span><br><span class="line">docker volume rm</span><br></pre></td></tr></table></figure>

<h3 id="数据卷挂载"><a href="#数据卷挂载" class="headerlink" title="数据卷挂载"></a>数据卷挂载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-v 前半部分是数据卷，后半部分是容器内目录</span></span><br><span class="line">docker run --name mn -v html:/root/html -p 8080:80 nginx</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<p>需求说明:上个案例中，我们进入nginx容器内部，已经知道nginx的html目录所在位置&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html，我们需要把这个目录挂载到html这个数据卷上，方便操作其中的内容。提示:运行容器时使用-v参数挂载数据卷</p>
<p>步骤:</p>
<ol>
<li><p>创建容器并挂载数据卷到容器内的HTML目录、</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建名为html的数据卷</span></span><br><span class="line">docker valume html</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建容器并挂载数据卷到容器内的html目录</span></span><br><span class="line">docker run --name mn -p 80:80 -v </span><br><span class="line">html:/usr/share/nginx/html -d nginx</span><br></pre></td></tr></table></figure>


</li>
<li><p>进入html数据卷所在位置，并修改HTML内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看数据卷的位置</span></span><br><span class="line">docker volume inspect html</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">计入该目录</span> </span><br><span class="line">cd </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改文件</span></span><br><span class="line">vi</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="宿主机目录挂载"><a href="#宿主机目录挂载" class="headerlink" title="宿主机目录挂载"></a>宿主机目录挂载</h4><p>宿主机目录可以直接挂载到容器</p>
<ul>
<li>-v [宿主机目录]:[容器内目录]</li>
<li>-v[宿主机文件]:[容器内文件]</li>
</ul>
<p>实现思路如下:</p>
<ol>
<li><p>在将课前资料中的mysql.tar文件上传到虚拟机，通过load命令加载为镜像</p>
</li>
<li><p>创建目录&#x2F;tmp&#x2F;myql&#x2F;data,</p>
</li>
<li><p>创建目录&#x2F;tmp&#x2F;myql&#x2F;conf，将课前资料提供的hmy.cnf文件上传到&#x2F;tmp&#x2F;myql&#x2F;conf4．</p>
</li>
<li><p>去DockerHub查阅资料，创建并运行MySQL容器，要求:</p>
<ul>
<li>挂载&#x2F;tmp&#x2F;myql&#x2F;data到mysql容器内数据存储目录</li>
<li>挂载&#x2F;tmp&#x2F;myql&#x2F;conf&#x2F;hmy.cnf到mysql容器的配置文件</li>
<li>设置MySQL密码</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">	--name mysql \</span><br><span class="line">	-e MYSAL_ROOT_PASSWORD=123 \</span><br><span class="line">	-p 3306:3306 \</span><br><span class="line">	-v /tmp/mysql/conf/hmy.cnf:/etc/mysql/conf.d/hmy.cnf \</span><br><span class="line">	-v /tmp/mysql/data:/var/lib/musql</span><br><span class="line">	-d \</span><br><span class="line">	mysql:5.7.25</span><br></pre></td></tr></table></figure></li>
</ol>
<p>总结：</p>
<ol>
<li>docker run的命令中通过-v参数挂载文件或目录到容器中：<ul>
<li>-v volume 名称:容器内目录</li>
<li>-v 宿主机文件:容器内文件</li>
<li>-v 宿主机目录:容器内目录</li>
</ul>
</li>
<li>数据卷挂载与目录直接挂载的区别：<ul>
<li>数据卷挂载耦合度低，由docker来管理，但是目录较深，不好找</li>
<li>目录挂载耦合度高，需要我们自己管理目录，不过目录容易寻找查看</li>
</ul>
</li>
</ol>
<h3 id="DockerFile自定义镜像"><a href="#DockerFile自定义镜像" class="headerlink" title="DockerFile自定义镜像"></a>DockerFile自定义镜像</h3><h4 id="镜像结构："><a href="#镜像结构：" class="headerlink" title="镜像结构："></a>镜像结构：</h4><p>镜像是一个分层结构，每一层称为一个layer：</p>
<ul>
<li>BaseImage层：包含基本的系统函数库、环境变量、文件系统</li>
<li>Entrypoint：入口，是镜像中应用启动的命令</li>
<li>其他：在BaseImage基础上添加依赖、安装程序、完成整个应用的安装和配置</li>
</ul>
<h4 id="DockerFile"><a href="#DockerFile" class="headerlink" title="DockerFile"></a>DockerFile</h4><p>DockerFile就是一个文本文件，其中包含一个个的指令，用指令来说明要执行什么操作来构建镜像。每一个指令都会形成一层layer</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>FROM</td>
<td>指定基础镜像</td>
<td>FROM centos:6</td>
</tr>
<tr>
<td>ENV</td>
<td>设置环境变量，可在后面指令使用</td>
<td>ENV key value</td>
</tr>
<tr>
<td>COPY</td>
<td>拷贝本地文件到镜像的指定目录</td>
<td>COPY .&#x2F;mysql-2.7.rpm &#x2F;tmp</td>
</tr>
<tr>
<td>RUN</td>
<td>执行linux的shell命令，一般是安装过程的命令</td>
<td>RUN yum  install gcc</td>
</tr>
<tr>
<td>EXPOSE</td>
<td>指定容器运行时监听的端口，是给镜像使用者看的</td>
<td>EXPOSE 8080</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>镜像中应用的启动命令，容器运行时调用</td>
<td>ENTRYPOINT java -jar  xx.jar</td>
</tr>
</tbody></table>
<p>案例：</p>
<p>基于Ubuntu镜像构建一个新镜像，运行一个java项目<br>步骤1∶新建一个空文件夹docker-demo<br>步骤2:拷贝课前资料中的docker-demo.jar文件到docker-demo这个目录<br>步骤3:拷贝课前资料中的jdk8.tar.gz文件到docker-demo这个目录<br>步骤4:拷贝课前资料提供的Dockerfile到docker-demo这个目录<br>步骤5:进入docker-demo<br>步骤6:运行命令:</p>
<p>DokerFile示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定基础镜像</span></span><br><span class="line">FROM centos:6</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置环境变量，JDK的安装目录</span></span><br><span class="line">ENV JAVA_DIR=/usr/local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝jdk和java项目的包</span></span><br><span class="line">COPY ./jdk8.tar.gz $JAVA_DIR/</span><br><span class="line">COPY ./docker-demo.jar /tmp/app.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装JDK</span></span><br><span class="line">Run cd $JAVA_DIR \</span><br><span class="line">	&amp;&amp; tar -xf ./jdk8.tar.gz \</span><br><span class="line">	&amp;&amp; mv ./jdk1.8.0_144 ./java8</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置环境变量</span></span><br><span class="line">ENV JAVA_HOME=$JAVA_DIR/java8</span><br><span class="line">ENV PATH=$PATH:$JAVA_DIR/bin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">暴露端口</span></span><br><span class="line">EXPOSE 8090</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">入口 Java项目的启动命令</span></span><br><span class="line">ENTRYPOINT java -jar .tmp/app.jar</span><br></pre></td></tr></table></figure>

<p>现在有人把安装jdk的步骤构建成了镜像，我们可以利用java:8-alpine镜像来构建自己的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定基础镜像</span></span><br><span class="line">FROM java:8-alpine</span><br><span class="line">COPY ./docker-demo.jar /tmp/app.jar</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">暴露端口</span></span><br><span class="line">EXPOSE 8090</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">入口 Java项目的启动命令</span></span><br><span class="line">ENTRYPOINT java -jar .tmp/app.jar</span><br></pre></td></tr></table></figure>

<h4 id="DockerCompose"><a href="#DockerCompose" class="headerlink" title="DockerCompose"></a>DockerCompose</h4><ul>
<li>DockerCompose可以基于Compose文件帮我们快速的部署分布式应用，而无需上搜东一个个创建和运行容器</li>
<li>Compose文件是一个文本文件，可以通过指令定义集群中的每一个容器如何运行</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3.8&quot;</span><br><span class="line">services:</span><br><span class="line">	mysql: #容器名称</span><br><span class="line">		image: mysql:5.7.25  #镜像名称</span><br><span class="line">		environment: </span><br><span class="line">			MYSQL_ROOT_PASSWORD:123 #设置密码</span><br><span class="line">		volumes: #数据卷</span><br><span class="line">			- /tmp/mysql/data:/var/lib/mysql</span><br><span class="line">			- /tmp/mysql/conf/hmy.cnf:/etc/mysql/conf.d/hmy.cnf</span><br><span class="line">	web: </span><br><span class="line">		build: . #构建 . 代表从当前目录构建镜像</span><br><span class="line">		ports:</span><br><span class="line">		 - 8090 : 8090</span><br></pre></td></tr></table></figure>



<h2 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h2><p>同步调用：你个妹子打视频电话</p>
<p>异步调用：你和19个妹子发微信消息</p>
<p>同步调用的问题：微服务之间基于Feign的调用就属于同步方式，存在一些问题</p>
<p>同步调用的优点：</p>
<ul>
<li>时效性强，可以立即得到结果</li>
</ul>
<p>同步调用的问题：</p>
<ul>
<li>耦合度高</li>
<li>性能和吞吐能力下降</li>
<li>有额外的资源消耗</li>
<li>有级联失败问题</li>
</ul>
<p>异步调用：异步调用常见实现就是事件驱动模式</p>
<p>异步通讯优势：</p>
<ul>
<li>服务解耦</li>
<li>吞吐量提升</li>
<li>故障隔离</li>
<li>流量削峰</li>
</ul>
<p>异步通信的缺点：</p>
<ul>
<li>依赖于Broker的可靠性、安全性、吞吐能力</li>
<li>架构复杂了，业务没有明显的流程线，不好跟踪管理</li>
</ul>
<p>什么是MQ</p>
<p>MQ（MessageQueue），中文是消息队列，字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。</p>
<table>
<thead>
<tr>
<th></th>
<th>RabbitMQ</th>
<th>ACtiveMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>公司&#x2F;社区</td>
<td>Rabbit</td>
<td>Apache</td>
<td>阿里</td>
<td>Apache</td>
</tr>
<tr>
<td>开发语言</td>
<td>Erlang</td>
<td>Java</td>
<td>Java</td>
<td>Scala&amp;Java</td>
</tr>
<tr>
<td>协议支持</td>
<td>AMQP、XMPP、SMTP、STOMP</td>
<td>OpenWire,STOMP,REST,XNPP,AMQP</td>
<td>自定义协议</td>
<td>自定义协议</td>
</tr>
<tr>
<td>可用性</td>
<td>高</td>
<td>一般</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td>一般</td>
<td>差</td>
<td>高</td>
<td>非常高</td>
</tr>
<tr>
<td>消息延迟</td>
<td>微秒级</td>
<td>毫秒级</td>
<td>毫秒级</td>
<td>毫秒以内</td>
</tr>
<tr>
<td>消息可靠性</td>
<td>高</td>
<td>一般</td>
<td>高</td>
<td>一般</td>
</tr>
</tbody></table>
<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><h4 id="单机部署"><a href="#单机部署" class="headerlink" title="单机部署"></a>单机部署</h4><p>下载镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:3-management</span><br></pre></td></tr></table></figure>

<p>执行下面命令来运行MQ容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">	-e RABBITMQ_DEFAULT_USER=rosevvi \ #设置环境变量</span><br><span class="line">	-e RABBITMQ_DEFAULT_PASS=123321 \</span><br><span class="line">	--name mq \  #起名</span><br><span class="line">	--hostname mq1 \ #配置主机名</span><br><span class="line">	-p 15672:15672 \ #端口映射 管理平台的端口</span><br><span class="line">	-p 5672:5672 \ #消息通信的端口</span><br><span class="line">	-d \</span><br><span class="line">	rabbitmq:3-management</span><br></pre></td></tr></table></figure>

<p>RabbitMQ的几个概念：</p>
<ul>
<li>channel：操作MQ的工具</li>
<li>exchange：路有消息到队列中</li>
<li>queue：缓存消息</li>
<li>virtual host：虚拟主机，是对queue、exchange等资源的逻辑分组</li>
</ul>
<h4 id="消息模型"><a href="#消息模型" class="headerlink" title="消息模型"></a>消息模型</h4><p>MQ的官方文档中给出了5个MQ的demo示例，对应了集中不同的用法：</p>
<ul>
<li>基本消息队列（BasicQueue）</li>
<li>工作消息队列（WorkQueue）</li>
<li>发布订阅（Publish、Subscribe），有根据交换机类型不同分为三种：<ul>
<li>FanoutExChange：广播</li>
<li>DirectExchange：路由</li>
<li>TopicExchange：主题</li>
</ul>
</li>
</ul>
<p>基本消息队列的消息发送流程：</p>
<ol>
<li>建立连接connection</li>
<li>创建channel</li>
<li>利用channel声明队列</li>
<li>利用channel向队列发送消息</li>
</ol>
<p>基本消息队列的消息接收流程：</p>
<ol>
<li>建立connection</li>
<li>创建channel</li>
<li>利用channel声明队列</li>
<li>定义consumer的消费行为handleDelivery（）</li>
<li>利用channel将消费者与队列绑定</li>
</ol>
<h3 id="SpringAMQP"><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h3><p>Advanced Message Queuing Protocol，是用于在应用程序之间传递业务消息的开放标准。该协议与语言和平台无关，更符合微服务中独立性的要求。</p>
<p>SpringAMQP 是基于AMQP协议定义的一套API规范，提供了模板来发送和接收消息。包含两部分，其中spring-amop是基础抽象，spring-rabbit是底层的默认实现。</p>
<p>案例：利用SpringAMQP实现helloworld中的基础消息队列功能</p>
<p>流程：</p>
<ol>
<li>在父工程中引入spring-amqp的依赖</li>
<li>在publisher服务中利用RabbitTemplate发送消息到simple.queue这个队列</li>
<li>在consumer服务中编写消费逻辑，绑定simple.queue 这个队列</li>
</ol>
<p>步骤一：</p>
<ol>
<li><p>引入AMQP依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>步骤二：</p>
<ol>
<li><p>在publisher服务中编写application.yml，添加mq连接信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">43.143</span><span class="number">.237</span><span class="number">.123</span> <span class="comment">#rabbitMQ的ip地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment">#端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span>  <span class="comment">#虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">rosevvi</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>在publisher服务中新建一个测试类，编写测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PublisherTest</span> &#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplatel;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRabbitTemplatel</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">queuename</span> <span class="operator">=</span> <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello rosevvi&quot;</span>;</span><br><span class="line">    rabbitTemplatel.convertAndSend(queuename,message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>步骤三：在consumer中编写消费逻辑，监听simple.queue</p>
<ol>
<li><p>在consumer服务中编写application.yml，添加mq连接信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">43.143</span><span class="number">.237</span><span class="number">.123</span> <span class="comment">#rabbitMQ的ip地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment">#端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span>  <span class="comment">#虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">rosevvi</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在consumer服务中新建一个类，编写消费逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.springframework.amqp.rabbit.annotation.RabbitListener(queues = <span class="string">&quot;simple.queue&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerSimpleQueueMessage</span><span class="params">(String  msg)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者收到消息:&#123;&quot;</span>+msg+<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="WorkQueue工作队列"><a href="#WorkQueue工作队列" class="headerlink" title="WorkQueue工作队列"></a>WorkQueue工作队列</h3><p>Workqueue，工作队列，可以提高消息处理速度，避免队列消息堆积</p>
<p>案例：模拟WorkQueue，实现一个队列绑定多个消费者</p>
<p>基本思路：</p>
<ol>
<li>在publisher服务中定义测试方法，每秒产生50条消息，发送到simple.queue</li>
<li>在consumer服务中定义两个消息监听者，都监听simple.queue</li>
<li>消费者1每秒处理50条消息，消费者2每秒处理10条消息。</li>
</ol>
<p>消费预取限制：修改application.yml文件，设置preFetch这个值，可以控制预取消息的上限.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">43.143</span><span class="number">.237</span><span class="number">.123</span> <span class="comment">#rabbitMQ的ip地址</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment">#端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span>  <span class="comment">#虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">rosevvi</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123321</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>发布、订阅</p>
<p>发布订阅模式与之前案例的区别就是允许将同一消息发送给多个消费者。实现方式是加入了exchange（交换机）</p>
<p>常见exchange类型包括：</p>
<ul>
<li>Fanout：广播</li>
<li>Direct：路由</li>
<li>Topic：话题</li>
</ul>
<h3 id="发布订阅-FanoutExchange"><a href="#发布订阅-FanoutExchange" class="headerlink" title="发布订阅-FanoutExchange"></a>发布订阅-FanoutExchange</h3><p>FanoutExchange会将收到的消息路由到每一个跟其绑定的queue</p>
<p>案例：</p>
<ol>
<li>在consumer服务中，利用代码声明队列、交换机，并将两者绑定。</li>
<li>在consumer服务中，编写两个消费者方法，分别监听fanout.queue1和fanout.queue2</li>
<li>在publisher中编写测试方法，向rosevvi.fanout发送消息</li>
</ol>
<p>步骤：</p>
<ol>
<li><p>在consumer服务声明Exchange、Queue、Binding</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutConfig</span> &#123;</span><br><span class="line">    <span class="comment">//定义交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;rosevvi.fanout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义队列1</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;rosevvi.queue1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//绑定队列1和交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1</span><span class="params">(Queue queue1,FanoutExchange fanoutExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue1).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义队列2</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;rosevvi.queue2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//绑定队列2和交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2</span><span class="params">(Queue queue2,FanoutExchange fanoutExchange)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue2).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>在consumer服务声明两个消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.springframework.amqp.rabbit.annotation.RabbitListener(queues = <span class="string">&quot;rosevvi.queue1&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerFanoutMessage1</span><span class="params">(String  msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;消费者1收到Fanout消息:&#123;&quot;</span>+msg+<span class="string">&quot;&#125;&quot;</span>+ LocalDateTime.now());</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@org</span>.springframework.amqp.rabbit.annotation.RabbitListener(queues = <span class="string">&quot;rosevvi.queue2&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerFanoutMessage2</span><span class="params">(String  msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;消费者2收到Fanout消息:&#123;&quot;</span>+msg+<span class="string">&quot;&#125;&quot;</span>+LocalDateTime.now());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在publisher服务发送消息到FanoutExchange</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fanOutExchangeTest</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//交换机名字</span></span><br><span class="line">    String name= <span class="string">&quot;rosevvi.fanout&quot;</span>;</span><br><span class="line">    <span class="comment">//消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;rosevvi,Hello&quot;</span>;</span><br><span class="line">   </span><br><span class="line">    rabbitTemplatel.convertAndSend(name,<span class="string">&quot;&quot;</span>,message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>交换机的作用是什么：</p>
<ul>
<li>接收publisher发送的消息</li>
<li>将消息按照规则路由到与之绑定的队列</li>
<li>不能缓存消息、路由失败消息丢失</li>
<li>FanoutExchange会将消息路由到每个绑定的队列</li>
</ul>
<p>声明队列、交换机、绑定关系的bean是什么：</p>
<ol>
<li>Queue</li>
<li>FanoutExchange</li>
<li>Binding</li>
</ol>
<h3 id="发布订阅-DirectExchange"><a href="#发布订阅-DirectExchange" class="headerlink" title="发布订阅-DirectExchange"></a>发布订阅-DirectExchange</h3><p>DirectExchange会将接收到的消息根据规则路由到指定的Queue，因此称为路由模式（routes）</p>
<ul>
<li>每一个Queue都与Exchange设置一个BindingKey</li>
<li>发布者发送消息时，指定消息的RoutingKey</li>
<li>Exchange将消息路由到BindingKey与消息RoutingKey一致的队列</li>
</ul>
<p>案例：利用SpringAMQP演示DirectExchange的使用</p>
<p>实现思路：</p>
<ol>
<li>利用@RabbitListener声明Exchange、Queue、RountingKey</li>
<li>在Consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2</li>
<li>在publisher中编写测试方法，向rosevvi.direct发送消息</li>
</ol>
<p>步骤1：在consumer服务声明Exchange、Queue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(&quot;rosevvi.direct.queue2&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;rosevvi.direct&quot;,type = ExchangeTypes.DIRECT),</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;red&quot;,&quot;yellow&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerDirectMessage2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;消费者2收到Direct消息:&#123;&quot;</span>+msg+<span class="string">&quot;&#125;&quot;</span>+LocalDateTime.now());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：<br>描述下Direct交换机与Fanout交换机的差异？</p>
<ul>
<li>Fanout交换机将消息路由给每一个与之绑定的队列</li>
<li>Direct交换机根据RoutingKey判断路由给那个队列</li>
<li>如果多个队列具有相同的RoutingKey，则于Fanout功能相似</li>
</ul>
<p>基于@RabbitListener注解声明队列和交换机有那些常见注解？</p>
<ul>
<li>@Queue</li>
<li>@Exchange</li>
</ul>
<h3 id="发布订阅-TopicExchange"><a href="#发布订阅-TopicExchange" class="headerlink" title="发布订阅-TopicExchange"></a>发布订阅-TopicExchange</h3><p>TopicExchange与DirectExchange类似，区别在于routingKey必须是多个单词的列表，并且以     .         分割</p>
<p>Queue与Exchange指定BindingKey时可以使用通配符：</p>
<ul>
<li>#：代指0个或多个单词</li>
<li>*：代指一个单词</li>
</ul>
<p>案例：利用SpringAMQP演示TopicExchange的使用</p>
<p>实现思路如下：</p>
<ol>
<li>并利用@RabbitListener声明Exchange、Queue、RoutingKey</li>
<li>在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2</li>
<li>在publisher中编写测试方法，向itcast.topic发送消息</li>
</ol>
<p>步骤1：在xonsumer服务声明Exchange、Queue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;rosevvi.topic.queue2&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;rosevvi.topic&quot;,type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;#.news&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenerTopicMessage2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;消费者2收到Topic消息:&#123;&quot;</span>+msg+<span class="string">&quot;&#125;&quot;</span>+LocalDateTime.now());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消息转换器"><a href="#消息转换器" class="headerlink" title="消息转换器"></a>消息转换器</h3><p>案例：测试发送Object类型消息</p>
<p>说明：在SpringAMQP的发送方法中，接收消息的类型时object，也就是说我们可以发送任意对象类型的消息，SpringAMQP会帮我们序列化为字节后发送。</p>
<p>Spring的消息对象处理是由MessageConverter来处理的。而默认实现是SimpleMessageConverter，基于JDK的ObjectOutputStream完成序列化。</p>
<p>如我要修改只需要定义一个MessageConverter类型的Bean即可。推荐使用Json方式序列化，步骤如下：</p>
<ol>
<li><p>在publisher服务引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在publisher服务声明MessageConverter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>SpringAMQP中消息的序列化和反序列化是怎么实现的？</p>
<ul>
<li>利用MessageConverter实现的，默认是JDK的序列化</li>
<li>注意发送方与接收方必须使用相同的MessageConverter</li>
</ul>
<h2 id="分布式搜索ElasticSearch"><a href="#分布式搜索ElasticSearch" class="headerlink" title="分布式搜索ElasticSearch"></a>分布式搜索ElasticSearch</h2><p>什么是elasticsearch</p>
<ul>
<li>elasticsearch是一款非常强大的开源搜索引擎，可以帮助我们从海量数据中快速找到需要的内容。可以用来实现搜索、日志统计、分析、系统监控等功能。</li>
</ul>
<p>什么是Elastic Stack（ELK）？</p>
<ol>
<li>是以Elasticsearch为核心的技术栈，包括beats、logstash、kibana、elasticsearch</li>
</ol>
<p>什么是Lucene？</p>
<ul>
<li>是Apache的开源搜索引擎类库，提供了搜索引擎的核心API</li>
</ul>
<h3 id="正向索引和倒排索引"><a href="#正向索引和倒排索引" class="headerlink" title="正向索引和倒排索引"></a>正向索引和倒排索引</h3><p>传统数据库（Mysql）采用正向索引，例如id自增利用id创建索引。</p>
<p>elasticsearch采用倒排索引：</p>
<ul>
<li>文档（document）：每条数据就是一个文档</li>
<li>词条（term）：文档按照语义分成的词语</li>
</ul>
<p>比如：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>title</th>
<th>price</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>小米手机</td>
<td>3499</td>
</tr>
<tr>
<td>2</td>
<td>华为手机</td>
<td>4999</td>
</tr>
<tr>
<td>3</td>
<td>华为小米充电器</td>
<td>49</td>
</tr>
<tr>
<td>4</td>
<td>小米手环</td>
<td>299</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>词条（term）</th>
<th>文档id</th>
</tr>
</thead>
<tbody><tr>
<td>小米</td>
<td>1，3，4</td>
</tr>
<tr>
<td>手机</td>
<td>1，2</td>
</tr>
<tr>
<td>华为</td>
<td>2，3</td>
</tr>
<tr>
<td>充电器</td>
<td>3</td>
</tr>
<tr>
<td>手环</td>
<td>4</td>
</tr>
</tbody></table>
<p>搜索时“华为手机”，会将华为手机进行分词，得到“华为”，“手机”两个词条，再利用词条去搜索得当文档id</p>
<p>总结：</p>
<p>什么是文档和词条？</p>
<ul>
<li>每一条数据就是一个文档</li>
<li>对文档中的内容分析，得到的词语就是词条</li>
</ul>
<p>什么是正向索引？</p>
<ul>
<li>基于文档id创建索引。查询词条时必须先找到文档，而后判断是否包含词条</li>
</ul>
<p>什么是倒排索引？</p>
<ul>
<li>对文档内容进行分词，对词条创建索引，并记录词条所在文档的信息。查询时现根据词条查询到文档id，而后获取到文档。</li>
</ul>
<p>文档：elasticsearch是面向文档存储的，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化为json格式后存储再elasticsearch中。</p>
<p>索引（index）：相同类型的文档的集合</p>
<p>映射（mapping）：索引中文档的字段约束信息，类似表的结构约束</p>
<p>概念对比：</p>
<table>
<thead>
<tr>
<th>mysql</th>
<th>elasticsearch</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Table</td>
<td>Index</td>
<td>索引（index），就是文档的集合，类似数据库的表（table）</td>
</tr>
<tr>
<td>Row</td>
<td>Document</td>
<td>文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是json格式</td>
</tr>
<tr>
<td>Column</td>
<td>Field</td>
<td>字段（Field），就是json文档中的字段，类似数据库中的列（Column）</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
<td>Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）</td>
</tr>
<tr>
<td>Sql</td>
<td>Dsl</td>
<td>Dsl是一个elasticsearch提供的json风格的请求语句，用来操作elasticsearch，实现FRUD</td>
</tr>
</tbody></table>
<p>架构</p>
<p>Mysql：擅长事务类型操作，可以确保数据的安全和一致性</p>
<p>ElasticSearch：擅长海量数据的搜索、分析、计算</p>
<h3 id="安装ElasticSearch"><a href="#安装ElasticSearch" class="headerlink" title="安装ElasticSearch"></a>安装ElasticSearch</h3><p>单点部署</p>
<p>创建网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create es-net</span><br></pre></td></tr></table></figure>

<p>加载镜像</p>
<p>这里采用elasticsearch的7.12.1版本的镜像，这个镜像体积非常大，接近1G。不建议自己pull，建议上传到虚拟机后，自行加载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i es.tar</span><br></pre></td></tr></table></figure>

<p>同理kibana的tar包也需要这样做</p>
<p>运行：运行docker命令，部署单点es：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">	--name es \</span><br><span class="line">	-e &quot;ES_$JAVA_OPTS=-Xms512m -Xms512m&quot; \</span><br><span class="line">	-e &quot;discovery.type=single-node&quot; \</span><br><span class="line">	-v es-data:/usr/share/elasticsearch/date \</span><br><span class="line">	-v es-plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">	--privileged \</span><br><span class="line">	--network es-net \</span><br><span class="line">	-p 9200:9200 \ #暴露再http协议的端口</span><br><span class="line">	-p 9300:9300 \ #es容器各个节点之间互联的端口</span><br><span class="line">elasticsearch:7.12.1</span><br></pre></td></tr></table></figure>

<p>命令解释：</p>
<ul>
<li>-e  “cluster.name&#x3D;es-docker-cluster”:设置集群名称</li>
<li>-e “http.host&#x3D;0.0.0.0”:监听的地址，可以外网访问</li>
<li>-e “ES_JAVA_OPTS&#x3D;-Xms512m -Xmx512m” :内存大小</li>
<li>-e “discovery.type&#x3D;single-node” :非集群模式</li>
<li>-v es-data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;date : 挂载逻辑卷，绑定es的数据目录</li>
<li>-v es-data:&#x2F;usr&#x2F;share&#x2F;elasticsearch&#x2F;plugins: 挂载逻辑卷，绑定es的插件目录</li>
<li>–privileged :授予逻辑卷访问权</li>
<li>–network es-net:加入一个名为es-net的网络中</li>
<li>-p 9200:9200:端口映射配置</li>
</ul>
<h3 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a>部署kibana</h3><p>kibana可以给我们提供一个elasticsearch的可视化界面，便于我们学习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">	--name kibana \</span><br><span class="line">	-e ELASTICSEARCH_HOSTS=http://es:9200 \</span><br><span class="line">	--network=es-net \</span><br><span class="line">	-p 5601:5601 \</span><br><span class="line">kibana:7.12.1</span><br></pre></td></tr></table></figure>

<ul>
<li>–network es-net:加入一个名为es-net的网络中，与elasticsearch在同一个网络中</li>
<li>-e ELASTICSEARCH_HOSTS&#x3D;<a href="http://es:9200:设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch">http://es:9200:设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch</a></li>
<li>-p 5601:5601:端口映射配置</li>
</ul>
<h3 id="安装IK分词器"><a href="#安装IK分词器" class="headerlink" title="安装IK分词器"></a>安装IK分词器</h3><p>es再创建倒排索引时需要对文档分词；再搜索时，需要对用户输入内容分词。但默认的分词规则对中文处理并不友好，我们再kibnana的DevTools中测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line">&#123;</span><br><span class="line">	&quot;analyzer&quot;:&quot;standard&quot;,</span><br><span class="line">	&quot;text&quot;:&quot;黑马程序员学习java太棒了&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>语法说明：</p>
<ul>
<li>POST：请求方式</li>
<li>&#x2F; _analyze：请求路径，这里省略了<a href="http://192.168.150.101:9200，有kibana帮我们补充">http://192.168.150.101:9200，有kibana帮我们补充</a></li>
<li>请求参数，json风格：<ul>
<li>analyzer：分词器类型，这里是默认的standard分词器</li>
<li>text：要分词的内容</li>
</ul>
</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>在线：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入容器内部</span></span><br><span class="line">docker exec -it elasticsearch /bin/bash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在线下载并安装</span></span><br><span class="line">./bin/elasticsearch-plugin install</span><br><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/release/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">退出</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启容器</span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure>

<p>离线：</p>
<p>安装插件需要指导elasticsearch的plugins目录位置，而我们用了数据卷挂载，因此需要查看elasticearch的数据卷目录，通过下面命令查看：</p>
<ol>
<li><pre><code class="shell">docker volume inspect es-plugins
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 解压分词器安装包，重命名为ik</span><br><span class="line"></span><br><span class="line">3. 上传到es容器的插件数据卷中，也就是/var/lib/docker/volumes/es-plugins/_data;</span><br><span class="line"></span><br><span class="line">4. 重启容器</span><br><span class="line"></span><br><span class="line">   ```shell</span><br><span class="line">   #重启容器</span><br><span class="line">   docker restart es</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看es日志</span></span><br><span class="line">docker logs -f es</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>测试：ik分词器包含两种模式</p>
<ul>
<li>ik_smart：最少切分</li>
<li>ik_max_word：最细切分</li>
</ul>
</li>
</ol>
<h3 id="IK分词器"><a href="#IK分词器" class="headerlink" title="IK分词器"></a>IK分词器</h3><h4 id="扩展词库-停用词库"><a href="#扩展词库-停用词库" class="headerlink" title="扩展词库-停用词库"></a>扩展词库-停用词库</h4><p>要扩展分词器的词库，只需要修改一个ik分词器目录中的config目录中的IKAnalyzer.cfg.xml文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF_8&quot;</span>?&gt;</span></span><br><span class="line">&lt;! DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">commemt</span>&gt;</span>Ik analyzer 扩展配置 <span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典***添加扩展字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>ext.did<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--用户可以在这里配置自己的扩展停用字典***添加停用词字典--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span>stopwords.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="索引库"><a href="#索引库" class="headerlink" title="索引库"></a>索引库</h3><h4 id="mapping属性"><a href="#mapping属性" class="headerlink" title="mapping属性"></a>mapping属性</h4><p>mapping属性时是对索引库中文档的约束，常见的mapping属性包括：</p>
<ul>
<li>type：字段数据类型，常见的简单类型有：<ul>
<li>字符串：text(可分词文本)、keyword(精确值，例如：品牌、国家、IP地址)</li>
<li>数值：long、integer、short、byte、double、float</li>
<li>布尔：boolean</li>
<li>日期：date</li>
<li>对象：object</li>
</ul>
</li>
<li>index：是否创建索引，默认为true</li>
<li>analyzer：使用那种分词器</li>
<li>properties：该字段的子字段</li>
</ul>
<h4 id="创建索引库"><a href="#创建索引库" class="headerlink" title="创建索引库"></a>创建索引库</h4><p>es中通过restful请求操作索引库、文档。请求内容用DSL语句来表示。创建索引库和mapping的DSL语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /rose</span><br><span class="line">&#123;</span><br><span class="line">	&quot;mapping&quot;:&#123;</span><br><span class="line">		&quot;properties&quot;:&#123;</span><br><span class="line">			&quot;info&quot;:&#123;</span><br><span class="line">				&quot;tupe&quot;:&quot;text&quot;,</span><br><span class="line">				&quot;analyzer&quot;:&quot;ik_smart&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;email&quot;:&#123;</span><br><span class="line">				&quot;type&quot;:&quot;keyword&quot;,</span><br><span class="line">				&quot;index&quot;:&quot;false&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;name&quot;:&#123;</span><br><span class="line">				&quot;properties&quot;:&#123;</span><br><span class="line">					&quot;firstName&quot;:&#123;</span><br><span class="line">						&quot;type&quot;:&quot;keyword&quot;	</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="索引库操作"><a href="#索引库操作" class="headerlink" title="索引库操作"></a>索引库操作</h4><p>查看索引库语法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /索引库名</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /rose</span><br></pre></td></tr></table></figure>

<p>删除索引库的语法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /索引库名</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>DELETE &#x2F;rose</p>
<p>修改索引库：</p>
<p>索引库和mapping一旦创建无法修改，但是可以添加新的字段，语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /索引库名/_mapping</span><br><span class="line">&#123;</span><br><span class="line">	&quot;properties&quot;:&#123;</span><br><span class="line">		&quot;新的字段名&quot;:&#123;</span><br><span class="line">			&quot;type&quot;:&quot;integer&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意新的字段一定是 原本不存在的</span></span><br></pre></td></tr></table></figure>

<h4 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h4><p>添加文档：  新增文档的DSL语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST</span><br><span class="line">&#123;</span><br><span class="line">	&quot;字段1&quot;:&quot;值1&quot;，</span><br><span class="line">	&quot;字段2&quot;:&quot;值2&quot;，</span><br><span class="line">	&quot;字段3&quot;:&#123;</span><br><span class="line">		&quot;子属性1&quot;:&quot;值3&quot;,</span><br><span class="line">		&quot;子属性2&quot;:&quot;值4&quot;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询文档语法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /索引库名/_doc/文档id</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /rose/_doc/1</span><br></pre></td></tr></table></figure>

<p>删除索引库的语法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /索引库名/_doc/文档id</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /rose/——doc/</span><br></pre></td></tr></table></figure>

<p>修改文档：</p>
<p>方式一：全量修改，回删除旧文档，添加新文档。 既能更新也能添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /索引库名/_doc/文档id</span><br><span class="line">&#123;</span><br><span class="line">	&quot;字段1&quot;:&quot;值1&quot;，</span><br><span class="line">	&quot;字段2&quot;:&quot;值2&quot;</span><br><span class="line">	//。。。略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方式二：增量修改，修改指定字段值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /索引库名/_update/文档id</span><br><span class="line">&#123;</span><br><span class="line">	&quot;doc&quot;:&#123;</span><br><span class="line">    	&quot;字段名&quot;:&quot;新的值&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RestClient操作索引库"><a href="#RestClient操作索引库" class="headerlink" title="RestClient操作索引库"></a>RestClient操作索引库</h3><p>什么是RestClient？ </p>
<p>ES官方提供了各种不同语言的客户端，用来操作ES。这些客户端的本质就是组装DSL语句，通过gttp请求发送给es。</p>
<p>案例：利用JavaRestClient实现创建、删除索引库，判断索引库是否存在</p>
<p>根据课前资料提供的九点数据创建索引库，索引库名为hotel，mapping属性根据数据库结构定义。</p>
<p>基本步骤如下：</p>
<ol>
<li>导入课前资料Demo</li>
<li>分析数据结构，定义mapping属性</li>
<li>初始化JavaRestClient</li>
<li>利用JavaRestClient创建索引库</li>
<li>利用JavaRestClient删除索引库</li>
<li>利用JavaRestClient判断索引库是否存在</li>
</ol>
<h4 id="步骤二：数据分析"><a href="#步骤二：数据分析" class="headerlink" title="步骤二：数据分析"></a>步骤二：数据分析</h4><p>Es中支持两种地理坐标数据类型：</p>
<ul>
<li>geo_point:由维度和经度确定的一个点：”32.8752345,120.2981576”</li>
<li>geo_shape:有多个geo_point组成的复杂几何图形。例如一条直线”LINESTRING(-77.03653 38.897676,-77.009051 38.889939)”</li>
</ul>
<p>字段拷贝可以使用copy_to属性将当前字段拷贝到指定字段。示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;all&quot;:&#123;</span><br><span class="line">	&quot;type&quot;:&quot;text&quot;,</span><br><span class="line">	&quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;brand&quot;&quot;&#123;</span><br><span class="line">	&quot;type&quot;:&quot;keyword&quot;,</span><br><span class="line">	&quot;copy_to&quot;:&quot;<span class="keyword">all</span>&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤三：初始化RestClient"><a href="#步骤三：初始化RestClient" class="headerlink" title="步骤三：初始化RestClient"></a>步骤三：初始化RestClient</h4><ol>
<li><p>引入es的RestHighClient依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elaeticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>因为Springboot默认的es版本是7.6.2，所以我们需要覆盖默认的es版本：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.12.1<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化RestHighLevelClient：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(</span><br><span class="line">	<span class="built_in">this</span>.client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(HttpHost.create(<span class="string">&quot;http:43.143.237.123:9200&quot;</span>)));</span><br><span class="line">))</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="步骤四：创建索引库"><a href="#步骤四：创建索引库" class="headerlink" title="步骤四：创建索引库"></a>步骤四：创建索引库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testInit</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1、创建Request对象</span></span><br><span class="line">        <span class="type">CreateIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">        <span class="comment">//2、请求参数，MAPPING_TEMPLATE是静态常量字符串，内容是创建索引可的DSL语句</span></span><br><span class="line">        request.source(MAAPING_TEMPLATE, XContentType.JSON);</span><br><span class="line">        <span class="comment">//3、发起请求</span></span><br><span class="line">        client.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤五：删除索引库、判断索引库是否存在"><a href="#步骤五：删除索引库、判断索引库是否存在" class="headerlink" title="步骤五：删除索引库、判断索引库是否存在"></a>步骤五：删除索引库、判断索引库是否存在</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1、创建Request对象</span></span><br><span class="line">    <span class="type">DeleteIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    <span class="comment">//3、发起请求</span></span><br><span class="line">    client.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testExits</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1、创建Request对象</span></span><br><span class="line">    <span class="type">GetIndexRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetIndexRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    <span class="comment">//3、发起请求</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> client.indices().exists(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.err.println(exists?<span class="string">&quot;索引库存在&quot;</span>:<span class="string">&quot;索引库不存在&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RestClient操作文档"><a href="#RestClient操作文档" class="headerlink" title="RestClient操作文档"></a>RestClient操作文档</h3><p>案例：利用JavaRestClient实现文档的CRUD</p>
<p>去数据库查询酒店数据，导入到hotel索引库，实现酒店数据的CRUD。</p>
<p>基本步骤如下：</p>
<ol>
<li>初始化JavaRestClient</li>
<li>利用JavaRestClient新增酒店数据</li>
<li>利用JavaRestClient根据id查询酒店数据</li>
<li>利用JavaRestClient删除酒店数据</li>
<li>利用JavaRestClient修改酒店数据</li>
</ol>
<h4 id="步骤一：初始化"><a href="#步骤一：初始化" class="headerlink" title="步骤一：初始化"></a>步骤一：初始化</h4><p>新建一个测试类，实现文档相关操作，并且完成javarestClient的初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotelDocumentTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(RestClient.builder(HttpHost.create(<span class="string">&quot;http://43.143.237.123:9200&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="步骤2：添加酒店数据到索引库"><a href="#步骤2：添加酒店数据到索引库" class="headerlink" title="步骤2：添加酒店数据到索引库"></a>步骤2：添加酒店数据到索引库</h4><p>先查询酒店数据，然后给这条数据创建倒排索引，即可完成添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> IHotelService iHotelService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testAddDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//查询数据</span></span><br><span class="line">    <span class="type">Hotel</span> <span class="variable">hotel</span> <span class="operator">=</span> iHotelService.getById(<span class="number">36934L</span>);</span><br><span class="line">    <span class="comment">//转换为文档类型</span></span><br><span class="line">    HotelDoc hotelDoc=<span class="keyword">new</span> <span class="title class_">HotelDoc</span>(hotel);</span><br><span class="line">    <span class="comment">//1、准备request对象</span></span><br><span class="line">    <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(hotel.getId().toString());</span><br><span class="line">    <span class="comment">//2、准备json文档</span></span><br><span class="line">    indexRequest.source(JSON.toJSONString(hotelDoc), XContentType.JSON);</span><br><span class="line">    <span class="comment">//3、发送请求</span></span><br><span class="line">    client.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤三：根据id查询酒店数据"><a href="#步骤三：根据id查询酒店数据" class="headerlink" title="步骤三：根据id查询酒店数据"></a>步骤三：根据id查询酒店数据</h4><p>根据id查询到的文档数据是json，需要反序列化为java对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testGetDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">GetRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(<span class="string">&quot;36934&quot;</span>);</span><br><span class="line">    <span class="type">GetResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.get(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> response.getSourceAsString();</span><br><span class="line">    <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(json, HotelDoc.class);</span><br><span class="line">    System.out.println(hotelDoc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤四：根据id修改酒店数据"><a href="#步骤四：根据id修改酒店数据" class="headerlink" title="步骤四：根据id修改酒店数据"></a>步骤四：根据id修改酒店数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testUpdateDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1、创建request对象</span></span><br><span class="line">    <span class="type">UpdateRequest</span> <span class="variable">request</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(<span class="string">&quot;hotel&quot;</span>,<span class="string">&quot;36934&quot;</span>);</span><br><span class="line">    <span class="comment">//2、准备请求参数</span></span><br><span class="line">    request.doc(</span><br><span class="line">            <span class="string">&quot;price&quot;</span>,<span class="string">&quot;380&quot;</span>,</span><br><span class="line">            <span class="string">&quot;starName&quot;</span>,<span class="string">&quot;新二钻&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//3、发送请求</span></span><br><span class="line">    client.update(request,RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="步骤五：根据id删除酒店数据"><a href="#步骤五：根据id删除酒店数据" class="headerlink" title="步骤五：根据id删除酒店数据"></a>步骤五：根据id删除酒店数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testDeleteDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1、创建request对象</span></span><br><span class="line">    <span class="type">DeleteRequest</span> <span class="variable">request</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(<span class="string">&quot;hotel&quot;</span>,<span class="string">&quot;36934&quot;</span>);</span><br><span class="line">    <span class="comment">//3、发送请求</span></span><br><span class="line">    client.delete(request,RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="tip：批处理"><a href="#tip：批处理" class="headerlink" title="tip：批处理"></a>tip：批处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testBulkDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//批量查询酒店数据</span></span><br><span class="line">    List&lt;Hotel&gt; list = iHotelService.list();</span><br><span class="line">    <span class="comment">//1、创建request对象</span></span><br><span class="line">    <span class="type">BulkRequest</span> <span class="variable">request</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">    <span class="comment">//2、准备参数</span></span><br><span class="line">    <span class="keyword">for</span> (Hotel hotel : list) &#123;</span><br><span class="line">        HotelDoc hotelDoc=<span class="keyword">new</span> <span class="title class_">HotelDoc</span>(hotel);</span><br><span class="line">        request.add(<span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;hotel&quot;</span>).id(</span><br><span class="line">                hotelDoc.getId().toString())</span><br><span class="line">                .source(JSON.toJSONString(hotelDoc),XContentType.JSON)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3、发送请求</span></span><br><span class="line">    client.bulk(request,RequestOptions.DEFAULT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DSL查询语法"><a href="#DSL查询语法" class="headerlink" title="DSL查询语法"></a>DSL查询语法</h3><h4 id="DSLQuery的分类"><a href="#DSLQuery的分类" class="headerlink" title="DSLQuery的分类"></a>DSLQuery的分类</h4><p>Elasticsearch提供了基于json的dsl来定义查询。常见的查询类型包括：</p>
<ul>
<li>查询所有：查询出所有数据，一般测试用。例如：match_all</li>
<li>全文检索（full text）查询：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：<ul>
<li>match_query</li>
<li>multi_match_query</li>
</ul>
</li>
<li>精确查询：根据精确词条值查找数据，一般是查找keyword、数值、日期、boolean等类型的字段。例如：<ul>
<li>ids</li>
<li>range</li>
<li>term</li>
</ul>
</li>
<li>地理（geo）查询：根据经纬度查询。例如：<ul>
<li>geo_distance</li>
<li>geo_bounding_box</li>
</ul>
</li>
<li>复合（compound）查询：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：<ul>
<li>bool</li>
<li>function_score</li>
</ul>
</li>
</ul>
<h4 id="DSL-Query基本语法"><a href="#DSL-Query基本语法" class="headerlink" title="DSL Query基本语法"></a>DSL Query基本语法</h4><p>​	查询的基本语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>indexName<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;查询类型&quot;:&#123;</span><br><span class="line">			&quot;查询条件&quot;:&quot;条件值&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询所有</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>indexName<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;:&#123;</span><br><span class="line">		</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="全文检索查询"><a href="#全文检索查询" class="headerlink" title="全文检索查询"></a>全文检索查询</h4><p>全文检索查询，会对用户输入内容分词，常用于搜索框搜索：</p>
<p>matcha查询：全文检索查询的一种，会对用户输入的内容进行分词，然后去倒排索引库检索，语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>indexName<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match&quot;:&#123;</span><br><span class="line">			&quot;FIELD&quot;:&quot;TEXT&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>multi_match：与match查询相似，只不过允许同时查询多个字段，语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>indexName<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;multi_match&quot;:&#123;</span><br><span class="line">			&quot;query&quot;:&quot;TEXT&quot;,</span><br><span class="line">			&quot;fields&quot;:[&quot;Field1&quot;,&quot;Field2&quot;]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="精确查询"><a href="#精确查询" class="headerlink" title="精确查询"></a>精确查询</h4><p>精确查询一般是查找keyword、数值、日期、boolean等类型字段。所以不会对搜索条件分词。常见的有：</p>
<ul>
<li>term：根据词条精确值查询</li>
<li>range：根据值的范围查询</li>
</ul>
<p>语法如下：</p>
<p>term:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;city&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;上海&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>range：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#精确查询 <span class="keyword">range</span></span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: <span class="number">335</span>,</span><br><span class="line">        &quot;lte&quot;: <span class="number">337</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="地理查询"><a href="#地理查询" class="headerlink" title="地理查询"></a>地理查询</h4><p>根据经纬度查询。常见的使用场景：</p>
<ul>
<li>携程：搜索我附近的酒店</li>
<li>滴滴：搜索我附近的出租车</li>
</ul>
<p>根据经纬度查询，官方文档。例如：</p>
<ul>
<li><p>geo_bounding_box：查询geo_point值落在某个举行范围的所有文档</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>indexName<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;geo_bounding_box&quot;:&#123;</span><br><span class="line">			&quot;FIELD&quot;:&#123;</span><br><span class="line">				&quot;top_left&quot;:&#123;</span><br><span class="line">                	&quot;lat&quot;:<span class="number">31.1</span>,</span><br><span class="line">                	&quot;lon&quot;:<span class="number">121.5</span></span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;bottom_right&quot;:&#123;</span><br><span class="line">					&quot;lat&quot;:<span class="number">30.9</span>,</span><br><span class="line">					&quot;lon&quot;:<span class="number">121.7</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>geo_distance：查询到指定中心点小于莫格距离值的所有文档</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>indexName<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;geo_distance&quot;:&#123;</span><br><span class="line">			&quot;distance&quot;:&quot;15km&quot;,</span><br><span class="line">			&quot;FIELD&quot;:&quot;31.21,121.5&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h4><p>复合查询：复合查询可以将其他简单查询组合起来，实现更复杂的搜索逻辑，例如：</p>
<ul>
<li>fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名。例如百度竞价</li>
</ul>
<p>相关性算分</p>
<p>当我们利用match查询时，文档结果回根据与搜索词条的关联度打分，返回结果时按照分值降序排列。</p>
<ul>
<li>TF（词条频率）&#x3D;词条出现次数 &#x2F; 文档中词条总数</li>
<li>TF—IDF算法：<ul>
<li>IDF（逆文档频率）&#x3D;log(文档总数 &#x2F; 包含词条的文档总数)</li>
<li>score&#x3D;∑TF词条频率 * IDF（逆文档频率）</li>
</ul>
</li>
<li>BM25算法（主流）</li>
</ul>
<h4 id="FunctionScoreQuery"><a href="#FunctionScoreQuery" class="headerlink" title="FunctionScoreQuery"></a>FunctionScoreQuery</h4><p>使用FunctionScoreQuery，可以修改文档的相关性算分，根据新的到的算分排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;all&quot;: &quot;上海&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;functions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;filter&quot;: &#123;</span><br><span class="line">            &quot;term&quot;: &#123;</span><br><span class="line">              &quot;id&quot;: &quot;5873072&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;weight&quot;: <span class="number">10</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;boost_mode&quot;: &quot;multiply&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>“query”:{“match”:{“all”:”外滩”}}：原始查询条件，搜索文档并根据相关性打分(query score)</li>
<li>“filter”:{“term”:{“id”:”1”}}            过滤条件，符合条件的文档才会背重新算分</li>
<li>“weight”:10         算分函数，算分函数结果称为function score ，将来回与query score运算得到新算分，常见算分函数有：<ul>
<li>weight：给一个常量值，作为函数结果</li>
<li>field_value_factor：用文档中的某个字段值作为函数结果</li>
<li>random_score：随机生成一个值，作为函数结果</li>
<li>script_score：自定义计算公式，公式结果作为函数结果</li>
</ul>
</li>
<li>“boost_mode”:”multiply”         加权模式，定义function score与query score的运算方式，包括：<ul>
<li>multiply：两者相乘。默认就是这个</li>
<li>replace：用function score 替换query score</li>
<li>其他：sum、avg、max、min</li>
</ul>
</li>
</ul>
<h4 id="BooleanQuery"><a href="#BooleanQuery" class="headerlink" title="BooleanQuery"></a>BooleanQuery</h4><p>布尔查询是一个或多个查询字句的组合，子查询的组合方式有：</p>
<ul>
<li>must：必须匹配每个子查询，类似”与”</li>
<li>should：选择性匹配子查询，类似”或”</li>
<li>must_not：必须不匹配，不参与算分，类似”非”</li>
<li>filter：必须匹配，不参与算分</li>
</ul>
<p>案例：利用bool查询实现功能：</p>
<p>需求：搜索名字包含如家，价格不高于400，在坐标31.21，121.5周围10km范围内的酒店。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#复合查询  BooleanQuery</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;如家&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;score&quot;: &#123;</span><br><span class="line">              &quot;gt&quot;: <span class="number">400</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;geo_distance&quot;: &#123;</span><br><span class="line">            &quot;distance&quot;: &quot;10km&quot;,</span><br><span class="line">            &quot;location&quot;: &#123;</span><br><span class="line">              &quot;lat&quot;: <span class="number">31.21</span>,</span><br><span class="line">              &quot;lon&quot;: <span class="number">121.5</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="搜索结果处理"><a href="#搜索结果处理" class="headerlink" title="搜索结果处理"></a>搜索结果处理</h3><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>elasticsearch支持对搜索结果排序，默认是根据相关度算分来排序。可以排序的字段类型有：keyword类型、数值类型、地理坐标类型、日期类型等。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 排序  标准</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;score&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 排序 地理坐标</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_geo_distance&quot;: &#123;</span><br><span class="line">        &quot;location&quot;: &#123;</span><br><span class="line">          &quot;lat&quot;: <span class="number">31.034661</span>,</span><br><span class="line">          &quot;lon&quot;: <span class="number">121.612282</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;,</span><br><span class="line">        &quot;unit&quot;: &quot;km&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p>elasticsearch默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了。</p>
<p>elastic search中通过修改from、size参数来控制要返回的分页结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#分页</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;from&quot;: <span class="number">0</span>,</span><br><span class="line">  &quot;size&quot;: <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>深度分页问题</strong></p>
<p>ES是分布式的，所以回面临深度分页问题。例如按照price排序后，获取from&#x3D;990，size&#x3D;10的数据：</p>
<ol>
<li>首先在每个数据片上都排序并查询前1000条文档</li>
<li>然后将所有节点的结果聚合，在内存中重新排序选出前1000条文档</li>
<li>最后从这10000条中，选取从990开始的10条文档</li>
</ol>
<p>如果搜索页数过深，或者结果集（from+size）越大，对内存和cpu的消耗越高。因此es色号顶结果集查询上线是10000</p>
<p><strong>深度分页解决方案</strong></p>
<p><strong>针对深度分页，es提供了两种解决方案</strong></p>
<ul>
<li>search  after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐</li>
<li>scroll：原理将排序数据形成快照，保存在内存。官方不推荐</li>
</ul>
<h4 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h4><p>高亮：就是在搜索结果中把搜索关键字突出显示</p>
<p>原理：</p>
<ul>
<li>将搜索结果中的关键字用标签标记出来</li>
<li>在页面中给标签添加css样式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#高亮</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;all&quot;: &quot;如家&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;require_field_match&quot;: &quot;false&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RestClient查询文档"><a href="#RestClient查询文档" class="headerlink" title="RestClient查询文档"></a>RestClient查询文档</h3><h4 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h4><p>我们通过match_all来演示基本的api</p>
<p>RestAPI中其中构建DSL是通过HighLevelRestClient中的resource来实现的，其中包含了查询、排序、分页、高亮等所有功能。</p>
<p>RestAPI中其中构建条件的核心部分是由一个名为QueryBuilders的工具类提供的，其中包含了各种查询方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testMatchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1、获取SearchRequest对象</span></span><br><span class="line">    SearchRequest request=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    <span class="comment">//2、设置参数</span></span><br><span class="line">    request.source().query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">//3、发请求</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">//4、处理结果集</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    <span class="type">TotalHits</span> <span class="variable">totalHits</span> <span class="operator">=</span> hits.getTotalHits();</span><br><span class="line">    System.out.println(totalHits);</span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//5.遍历</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(source, HotelDoc.class);</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="全文检索查询-1"><a href="#全文检索查询-1" class="headerlink" title="全文检索查询"></a>全文检索查询</h4><p>match</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testMatch</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1、获取SearchRequest对象</span></span><br><span class="line">    SearchRequest request=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    <span class="comment">//2、设置参数</span></span><br><span class="line">    request.source().query(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;如家&quot;</span>));</span><br><span class="line">    <span class="comment">//3、发请求</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    handlerResponse(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>boolean: term、range</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Test</span></span><br><span class="line">void testBool() throws IOException &#123;</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">1</span>、获取SearchRequest对象</span><br><span class="line">    SearchRequest request<span class="operator">=</span><span class="keyword">new</span> SearchRequest(&quot;hotel&quot;);</span><br><span class="line">    BoolQueryBuilder boolQuery <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">2</span>、设置dsl传语句</span><br><span class="line">    boolQuery.must(QueryBuilders.termQuery(&quot;city&quot;,&quot;北京&quot;));</span><br><span class="line">    boolQuery.mustNot(QueryBuilders.rangeQuery(&quot;price&quot;).gt(<span class="number">500</span>));</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">2</span>、设置参数</span><br><span class="line">    request.source().query(boolQuery);</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">3</span>、发请求</span><br><span class="line">    SearchResponse response <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    handlerResponse(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="排序和分页"><a href="#排序和分页" class="headerlink" title="排序和分页"></a>排序和分页</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Test</span></span><br><span class="line">void testPageAndSort() throws IOException &#123;</span><br><span class="line">    <span class="type">int</span> page <span class="operator">=</span> <span class="number">2</span>,size <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">1</span>、获取SearchRequest对象</span><br><span class="line">    SearchRequest request<span class="operator">=</span><span class="keyword">new</span> SearchRequest(&quot;hotel&quot;);</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">2</span>、设置参数</span><br><span class="line">    request.source().query(QueryBuilders.matchAllQuery());</span><br><span class="line">    request.source().<span class="keyword">from</span>((page<span class="number">-1</span>) <span class="operator">*</span> size).size(size);</span><br><span class="line">    request.source().sort(&quot;price&quot;, SortOrder.ASC);</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">3</span>、发请求</span><br><span class="line">    SearchResponse response <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    handlerResponse(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="高亮-1"><a href="#高亮-1" class="headerlink" title="高亮"></a>高亮</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">testHighLight</span>() throws <span class="title class_">IOException</span> &#123;</span><br><span class="line">       <span class="comment">//1、获取SearchRequest对象</span></span><br><span class="line">       <span class="title class_">SearchRequest</span> request=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">       <span class="comment">//2、设置参数</span></span><br><span class="line">       request.<span class="title function_">source</span>().<span class="title function_">query</span>(<span class="title class_">QueryBuilders</span>.<span class="title function_">matchQuery</span>(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;北京&quot;</span>));</span><br><span class="line">       request.<span class="title function_">source</span>().<span class="title function_">highlighter</span>(<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>().<span class="title function_">field</span>(<span class="string">&quot;name&quot;</span>).requireFieldMatch(<span class="literal">false</span>));</span><br><span class="line">       <span class="comment">//3、发请求</span></span><br><span class="line">       <span class="title class_">SearchResponse</span> response = client.<span class="title function_">search</span>(request, <span class="title class_">RequestOptions</span>.<span class="property">DEFAULT</span>);</span><br><span class="line">       <span class="title function_">handlerResponse</span>(response);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlerResponse</span><span class="params">(SearchResponse response)</span> &#123;</span><br><span class="line">    <span class="comment">//4、处理结果集</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">    <span class="type">TotalHits</span> <span class="variable">totalHits</span> <span class="operator">=</span> hits.getTotalHits();</span><br><span class="line">    System.out.println(totalHits);</span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">//5.遍历</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">        <span class="type">HotelDoc</span> <span class="variable">hotelDoc</span> <span class="operator">=</span> JSON.parseObject(source, HotelDoc.class);</span><br><span class="line">        Map&lt;String, HighlightField&gt; map = searchHit.getHighlightFields();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(map))&#123;</span><br><span class="line">            <span class="type">HighlightField</span> <span class="variable">highlightField</span> <span class="operator">=</span> map.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (highlightField!= <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> highlightField.getFragments()[<span class="number">0</span>].string();</span><br><span class="line">                hotelDoc.setName(string);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(hotelDoc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据聚合"><a href="#数据聚合" class="headerlink" title="数据聚合"></a>数据聚合</h3><p>聚合的分类</p>
<p>聚合可以实现对文档数据的统计、分析、运算。聚合常见的有三大类：</p>
<ul>
<li>桶(Bucket)聚合：用来对文档做分组<ul>
<li>TermAggregation：按照文档字段值分组</li>
<li>DateHistogram：按照容器阶梯分组，例如一周为一组，或一月为一组</li>
</ul>
</li>
<li>度量(Metric)聚合：用以计算一些值，比如：最大值、最小值、平均值等<ul>
<li>AVG：求平均值</li>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求max、min、avg、sum等</li>
</ul>
</li>
<li>管道(pipeline)聚合：其他聚合的结果为基础做聚合</li>
</ul>
<p>聚合字段类型必须是：keyword、数值、日期、布尔。</p>
<h4 id="DSL实现Bucket聚合"><a href="#DSL实现Bucket聚合" class="headerlink" title="DSL实现Bucket聚合"></a>DSL实现Bucket聚合</h4><p>现在我们要统计所有数据中的酒店品牌有几种，此时可以根据酒店品牌的名称做聚合。类型为term</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 聚合查询</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;lte&quot;: <span class="number">500</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: <span class="number">0</span>, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brandAgg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;,</span><br><span class="line">        &quot;size&quot;: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>聚合结果排序</p>
<p>默认情况下，bucket聚合会统计Bucket内的文档数量，记为_count，并且按照 _count降序来排序，我们可以修改结果排序方式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 聚合查询</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;lte&quot;: <span class="number">500</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: <span class="number">0</span>, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brandAgg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;,</span><br><span class="line">        &quot;size&quot;: <span class="number">20</span>,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;_count&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，我们可以限定要做聚合的文档范围，只要添加query条件即可</p>
<h4 id="DSL实现Metrics聚合"><a href="#DSL实现Metrics聚合" class="headerlink" title="DSL实现Metrics聚合"></a>DSL实现Metrics聚合</h4><p>例如我们要求获取每个品牌的用户评分的min、max、avg等值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 数据聚合stats</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>hotel<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: <span class="number">0</span>, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;lte&quot;: <span class="number">1000</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brandAgg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;,</span><br><span class="line">        &quot;size&quot;: <span class="number">10</span>,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;scoreAgg.avg&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;scoreAgg&quot;: &#123;</span><br><span class="line">          &quot;stats&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;score&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="RestClient实现聚合"><a href="#RestClient实现聚合" class="headerlink" title="RestClient实现聚合"></a>RestClient实现聚合</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Test</span></span><br><span class="line">void testAggregation() throws IOException &#123;</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">1</span>、获取SearchRequest对象</span><br><span class="line">    SearchRequest request <span class="operator">=</span> <span class="keyword">new</span> SearchRequest(&quot;hotel&quot;);</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">2</span>、设置参数</span><br><span class="line">    request.source().size(<span class="number">0</span>);</span><br><span class="line">    request.source().aggregation(AggregationBuilders.terms(&quot;branAgg&quot;).field(&quot;brand&quot;).size(<span class="number">5</span>));</span><br><span class="line">    <span class="operator">/</span><span class="operator">/</span><span class="number">3</span>、发请求</span><br><span class="line">    SearchResponse response <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    Aggregations aggregations <span class="operator">=</span> response.getAggregations();</span><br><span class="line">    Terms brandTerms <span class="operator">=</span> aggregations.get(&quot;branAgg&quot;);</span><br><span class="line">    List<span class="operator">&lt;</span>? extends Terms.Bucket<span class="operator">&gt;</span> buckets <span class="operator">=</span> brandTerms.getBuckets();</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">        String key <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">        System.out.println(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自动补全"><a href="#自动补全" class="headerlink" title="自动补全"></a>自动补全</h3><h4 id="拼音分词器"><a href="#拼音分词器" class="headerlink" title="拼音分词器"></a>拼音分词器</h4><p>要实现根据字母做补全，就必须对文档按照拼音分词。在github上恰好有elasticsearch的拼音分词插件。</p>
<p>elasticsearch中分词器的组成包含三个部分：</p>
<ul>
<li>character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符</li>
<li>tokenizer：将文本按照一定的规则切割成词条，例如keyword、就是不分词；还有ik_smart</li>
<li>tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</li>
</ul>
<h4 id="自定义分词器"><a href="#自定义分词器" class="headerlink" title="自定义分词器"></a>自定义分词器</h4><p>我们可以在创建索引库时，通过settings来配置自定义的analyzer（分词器）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">put <span class="operator">/</span>test</span><br><span class="line">&#123;</span><br><span class="line">	&quot;settings&quot;:&#123;</span><br><span class="line">		&quot;analysis&quot;:&#123;</span><br><span class="line">			&quot;analyzer&quot;:&#123;#自定义分词器</span><br><span class="line">				&quot;my_analyzer&quot;:&#123; #自定义的分词器名</span><br><span class="line">					&quot;tokenizer&quot;:&quot;ik_max_word&quot;,</span><br><span class="line">					&quot;filter&quot;:&quot;pinyin&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> 自定义拼音分词器</span><br><span class="line">PUT <span class="operator">/</span>test</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123; </span><br><span class="line">        &quot;my_analyzer&quot;: &#123; </span><br><span class="line">          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">          &quot;filter&quot;: &quot;py&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;py&quot;: &#123; </span><br><span class="line">          &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: <span class="literal">false</span>,</span><br><span class="line">          &quot;keep_joined_full_pinyin&quot;: <span class="literal">true</span>,</span><br><span class="line">          &quot;keep_original&quot;: <span class="literal">true</span>,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: <span class="number">16</span>,</span><br><span class="line">          &quot;remove_duplicated_term&quot;: <span class="literal">true</span>,</span><br><span class="line">          &quot;none_chinese_pinyin_tokenize&quot;: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>自定义分词器适合在创建倒排索引的时候使用，但不能再搜索的时候使用。</p>
<p>因此字段在创建倒排索引时应该用my_analyzer分词器；在搜索时应使用ik_smart分词器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 自定义拼音分词器</span><br><span class="line">PUT <span class="operator">/</span>test</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123; </span><br><span class="line">        &quot;my_analyzer&quot;: &#123; </span><br><span class="line">          &quot;tokenizer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">          &quot;filter&quot;: &quot;py&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;py&quot;: &#123; </span><br><span class="line">          &quot;type&quot;: &quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_full_pinyin&quot;: <span class="literal">false</span>,</span><br><span class="line">          &quot;keep_joined_full_pinyin&quot;: <span class="literal">true</span>,</span><br><span class="line">          &quot;keep_original&quot;: <span class="literal">true</span>,</span><br><span class="line">          &quot;limit_first_letter_length&quot;: <span class="number">16</span>,</span><br><span class="line">          &quot;remove_duplicated_term&quot;: <span class="literal">true</span>,</span><br><span class="line">          &quot;none_chinese_pinyin_tokenize&quot;: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;mappngs&quot;:&#123;</span><br><span class="line">      	&quot;properties&quot;:&#123;</span><br><span class="line">      		&quot;name&quot;:&#123;</span><br><span class="line">      			&quot;type&quot;:&quot;text&quot;,</span><br><span class="line">      			&quot;analyzer&quot;:&quot;my_analyzer&quot;,</span><br><span class="line">      			&quot;search_analyzer&quot;:&quot;ik_smart&quot;</span><br><span class="line">      		&#125;</span><br><span class="line">      	&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="completion-suggester查询"><a href="#completion-suggester查询" class="headerlink" title="completion suggester查询"></a>completion suggester查询</h4><p>elasticsearch提供了Completion suggester查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询效率，对于文档中字段的类型有一些约束：</p>
<ul>
<li><p>参与补全查询的字段必须是completion类型</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">put test</span><br><span class="line">&#123;</span><br><span class="line">	&quot;mappings&quot;:&#123;</span><br><span class="line">		&quot;properties&quot;:&#123;</span><br><span class="line">			&quot;title&quot;:&#123;</span><br><span class="line">				&quot;type&quot;:&quot;completion&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>字段的内容一般是用来补全的多个词条形成的数组</p>
</li>
</ul>
<p>查询语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>test<span class="operator">/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;suggest&quot;:&#123;</span><br><span class="line">		&quot;title_seggest&quot;:&#123;</span><br><span class="line">			&quot;text&quot;:&quot;s&quot;, #关键字</span><br><span class="line">			&quot;completion&quot;:&#123;</span><br><span class="line">				&quot;field&quot;:&quot;title&quot;, #补全查询的字段</span><br><span class="line">				&quot;skip_duplicates&quot;:&quot;true&quot;, #跳过重复的</span><br><span class="line">				&quot;size&quot;:<span class="number">10</span> #获取前十条数据</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RestApi实现自动补全"><a href="#RestApi实现自动补全" class="headerlink" title="RestApi实现自动补全"></a>RestApi实现自动补全</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSuggest</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1、获取SearchRequest对象</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;hotel&quot;</span>);</span><br><span class="line">    <span class="comment">//2、设置参数</span></span><br><span class="line">    request.source().suggest(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SuggestBuilder</span>().addSuggestion(</span><br><span class="line">                    <span class="string">&quot;my_suggest&quot;</span>,</span><br><span class="line">                    SuggestBuilders.completionSuggestion(<span class="string">&quot;suggestion&quot;</span>)</span><br><span class="line">                            .prefix(<span class="string">&quot;s&quot;</span>)</span><br><span class="line">                            .skipDuplicates(<span class="literal">true</span>)</span><br><span class="line">                            .size(<span class="number">10</span>)</span><br><span class="line">            )</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//3、发请求</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="type">Suggest</span> <span class="variable">suggest</span> <span class="operator">=</span> response.getSuggest();</span><br><span class="line">    <span class="type">CompletionSuggestion</span> <span class="variable">my_suggest</span> <span class="operator">=</span> suggest.getSuggestion(<span class="string">&quot;my_suggest&quot;</span>);</span><br><span class="line">    List&lt;CompletionSuggestion.Entry.Option&gt; options = my_suggest.getOptions();</span><br><span class="line">    <span class="keyword">for</span> (CompletionSuggestion.Entry.Option option : options) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> option.getText().string();</span><br><span class="line">        System.out.println(text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="数据同步-重要"><a href="#数据同步-重要" class="headerlink" title="数据同步(重要)"></a><strong>数据同步</strong>(重要)</h3><p>Elasticsearch中的酒店数据来自于mysql数据库，因此，mysql数据库发生改变时，elasticsearch也必须跟着改变，这个就时elasticsearch与mysql之间的数据同步。</p>
<h4 id="同步调用"><a href="#同步调用" class="headerlink" title="同步调用"></a>同步调用</h4><p>当酒店管理服务操作mysql数据库时，调用酒店搜索服务暴露的接口来修改Es</p>
<h4 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h4><p>使用mq中间件来实现，当酒店管理服务操作mysql数据库时，利用MQ通知酒店搜索服务，让酒店搜索服务更新ES</p>
<h4 id="监听binlog"><a href="#监听binlog" class="headerlink" title="监听binlog"></a>监听binlog</h4><p>使用mysql的binlog来实现，当酒店管理服务操作mysql数据库时，利用canal来监听mysql的binlog，当binlog改变就通知酒店搜索服务数据变更，酒店搜索服务来更新ES</p>
<p>总结：</p>
<ol>
<li>同步调用<ul>
<li>优点：实现简单，粗暴</li>
<li>缺点：业务耦合度高</li>
</ul>
</li>
<li>异步通知<ul>
<li>优点：低耦合，实现难度一般</li>
<li>缺点：依赖mq的高可靠性</li>
</ul>
</li>
<li>监听binlog<ul>
<li>优点：完全解除服务间耦合</li>
<li>缺点：开启binlog增加数据库负担、实现复杂度高</li>
</ul>
</li>
</ol>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><p>利用MQ实现mysql与es数据同步</p>
<p>步骤：</p>
<ul>
<li>导入课前资料提供的hotel-admin项目，启动并测试酒店数据的CRUD</li>
<li>声明exchange、queue、RoutingKey</li>
<li>在hote-admin中的增、删、改业务中完成消息发送</li>
<li>在hotel-demo中完成消息监听，并更新elasticsearch中数据</li>
<li>启动并测试数据同步功能</li>
</ul>
<h5 id="步骤二"><a href="#步骤二" class="headerlink" title="步骤二"></a>步骤二</h5><p>声明exchange、queue、RoutingKey</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">topicExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(HotelMqConstants.EXCHANGE_NAME,<span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入和修改队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">insertQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(HotelMqConstants.INSERT_QUEUE_NAME,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入和修改队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">deleteQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(HotelMqConstants.DELETE_QUEUE_NAME,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入与修改绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">insertBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(insertQueue()).to(topicExchange()).with(HotelMqConstants.INSERT_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除绑定关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">deleteBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(HotelMqConstants.DELETE_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="步骤三"><a href="#步骤三" class="headerlink" title="步骤三"></a>步骤三</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveHotel</span><span class="params">(<span class="meta">@RequestBody</span> Hotel hotel)</span>&#123;</span><br><span class="line">    <span class="comment">// 新增酒店</span></span><br><span class="line">    hotelService.save(hotel);</span><br><span class="line">    <span class="comment">// 发送MQ消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(HotelMqConstants.EXCHANGE_NAME, HotelMqConstants.INSERT_KEY, hotel.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="步骤四"><a href="#步骤四" class="headerlink" title="步骤四"></a>步骤四</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听插入和修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = HotelMqConstants.INSERT_QUEUE_NAME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenHotelInsertOrUpdate</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    iHotelService.insertById(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听删除</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = HotelMqConstants.DELETE_QUEUE_NAME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenHotelDelete</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    iHotelService.deleteById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ES集群"><a href="#ES集群" class="headerlink" title="ES集群"></a>ES集群</h3><p>单机的es做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p>
<ul>
<li>海量数据存储问题：将索引库从逻辑上拆分为N个分片，存储到多个节点</li>
<li>单点故障问题：将分片数据在不同节点做备份</li>
</ul>
<h4 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h4><p>docker-compose</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;2.2&#x27;</span><br><span class="line">services:</span><br><span class="line">  es01:</span><br><span class="line">    image: elasticsearch:7.12.1</span><br><span class="line">    container_name: es01 #容器名</span><br><span class="line">    environment:</span><br><span class="line">      - node.name=es01</span><br><span class="line">      - cluster.name=es-docker-cluster</span><br><span class="line">      - discovery.seed_hosts=es02,es03  #另外两个ip  docker内可以用名</span><br><span class="line">      - cluster.initial_master_nodes=es01,es02,es03 #主节点选举 </span><br><span class="line">      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - data01:/usr/share/elasticsearch/data</span><br><span class="line">    ports:</span><br><span class="line">      - 9200:9200</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  es02:</span><br><span class="line">    image: elasticsearch:7.12.1</span><br><span class="line">    container_name: es02</span><br><span class="line">    environment:</span><br><span class="line">      - node.name=es02</span><br><span class="line">      - cluster.name=es-docker-cluster</span><br><span class="line">      - discovery.seed_hosts=es01,es03</span><br><span class="line">      - cluster.initial_master_nodes=es01,es02,es03</span><br><span class="line">      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - data02:/usr/share/elasticsearch/data</span><br><span class="line">    ports:</span><br><span class="line">      - 9201:9200</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">  es03:</span><br><span class="line">    image: elasticsearch:7.12.1</span><br><span class="line">    container_name: es03</span><br><span class="line">    environment:</span><br><span class="line">      - node.name=es03</span><br><span class="line">      - cluster.name=es-docker-cluster</span><br><span class="line">      - discovery.seed_hosts=es01,es02</span><br><span class="line">      - cluster.initial_master_nodes=es01,es02,es03</span><br><span class="line">      - &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - data03:/usr/share/elasticsearch/data</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">    ports:</span><br><span class="line">      - 9202:9200</span><br><span class="line">volumes:</span><br><span class="line">  data01:</span><br><span class="line">    driver: local</span><br><span class="line">  data02:</span><br><span class="line">    driver: local</span><br><span class="line">  data03:</span><br><span class="line">    driver: local</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  elastic:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure>

<p>es运行还需要修改一些linux的系统权限，修改&#x2F;etc&#x2F;sysctl.conf文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加下面内容</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">然后执行命令，让配置生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h4 id="集群状态监控"><a href="#集群状态监控" class="headerlink" title="集群状态监控"></a>集群状态监控</h4><p>kibana监控不好用，用cerebro来监控集群状态，解压后直接用</p>
<p>创建索引库</p>
<ol>
<li><p>利用kibana的devtools创建索引库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">put <span class="operator">/</span>rose</span><br><span class="line">&#123;</span><br><span class="line">	&quot;settings&quot;:&#123;</span><br><span class="line">		&quot;number_of_shards&quot;:<span class="number">3</span>, #分片数量</span><br><span class="line">		&quot;number_of_replicas&quot;:<span class="number">1</span>  #副本数量</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;mappings&quot;:&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="ES集群职责和脑裂"><a href="#ES集群职责和脑裂" class="headerlink" title="ES集群职责和脑裂"></a>ES集群职责和脑裂</h4><table>
<thead>
<tr>
<th>节点类型</th>
<th>配置参数</th>
<th>默认值</th>
<th>节点职责</th>
</tr>
</thead>
<tbody><tr>
<td>master eligible</td>
<td>node.master</td>
<td>true</td>
<td>备选主节点：主节点可以管理和记录集群状态、决定分片在那个节点、处理创建和删除索引库的请求</td>
</tr>
<tr>
<td>data</td>
<td>node.data</td>
<td>true</td>
<td>数据节点：存储数据、搜索、聚合、CRUD</td>
</tr>
<tr>
<td>ingest</td>
<td>node.ingest</td>
<td>true</td>
<td>数据存储之前的预处理</td>
</tr>
<tr>
<td>coordingting</td>
<td>上面三个都为false，则为coordingnating节点</td>
<td>五</td>
<td>路由请求到其他节点，合并其他节点处理的结果，返回给用户</td>
</tr>
</tbody></table>
<p>es中的每个节点角色都有自己不同的职责，因此建议集群部署时，每个节点都有独立的角色。</p>
<h5 id="脑裂"><a href="#脑裂" class="headerlink" title="脑裂"></a>脑裂</h5><p>默认情况下，每个节点都是master eligible节点，因此一旦master节点宕机，其他候选节点会选举一个称为新的主节点。当主节点与其他节点网络故障时，可能发生脑裂问题。</p>
<p>为了避免脑裂问题，需要要求选票超过(eligible节点数量+1)&#x2F;2才能当选为主节点，因此eligible节点数量最好是奇数。对应配置项时discover.zen.minimum_master_nodes，在es7之后，已经成为默认配置，因此一般不会发生脑裂问题。</p>
<h4 id="ES集群的分布式存储"><a href="#ES集群的分布式存储" class="headerlink" title="ES集群的分布式存储"></a>ES集群的分布式存储</h4><p>当心怎文档时，应该保存到不同分片，保证数据均衡，那么coordingnating node如何确定数据改存储到那个分片呢？</p>
<p>Es会通过hash算法来计算文档应该存储到那个分片：</p>
<p>​					shard &#x3D; hash(_routing) % number_of_shards</p>
<p>说明：</p>
<ul>
<li>_routing默认是文档的id</li>
<li>number_of_shards分片数量</li>
</ul>
<p><strong>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改</strong></p>
<p>ES的查询分成两个阶段：</p>
<ul>
<li>scatter phase：分散阶段，coordinating node会把请求分到每一个分片</li>
<li>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</li>
</ul>
<h4 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h4><p>集群的master节点回监控集群中节点状态，如果发现有节点宕机，回立刻将宕机节点的分片数据迁移到其他节点，确保数据安全，这个叫做故障转移</p>
<h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h2><h3 id="雪崩问题"><a href="#雪崩问题" class="headerlink" title="雪崩问题"></a>雪崩问题</h3><p>微服务调用链路中的某个服务故障，引起整个链路中的所有微服务都不可用，这就是雪崩。</p>
<p><strong>解决雪崩问题的常见方式有四种：</strong></p>
<ul>
<li>超时处理：设定超时时间，请求超时一定时间没有响应就返回错误消息，不会无休止等待。</li>
<li>舱壁模式：限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。</li>
<li>熔断降级：由断路器统计业务执行的异常比例，如果超出阈值则会熔断该业务，来接访问该业务的一切请求。</li>
<li>流量控制：限制业务访问的QPS，避免服务因流量的徒增而故障</li>
</ul>

    </div>

    
    
    

    <div>
        
        

        
    </div>

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>rosevvi
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://rosevvi.cn/2023/05/28/14-22-46/" title="Spring Cloud">http://rosevvi.cn/2023/05/28/14-22-46/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/Spring-Cloud/" rel="tag"># Spring Cloud</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/05/25/14-22-46/" rel="prev" title="My First Post">
                  <i class="fa fa-chevron-left"></i> My First Post
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/28/14-22-46/" rel="next" title="TencentSMS">
                  TencentSMS <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rosevvi</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">86k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:37</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/luumod" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
